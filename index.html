<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen Persuratan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        // Konfigurasi Firebase - SUDAH DIKONFIGURASI
        const firebaseConfig = {
            apiKey: "AIzaSyC83Fu6oD8_bIvrepYDcLKAtoDEpeUe-N8",
            authDomain: "sipersurat.firebaseapp.com",
            projectId: "sipersurat",
            storageBucket: "sipersurat.firebasestorage.app",
            messagingSenderId: "260121323937",
            appId: "1:260121323937:web:7a099f8dcf197a194283e0"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Make Firebase available globally
        window.db = db;
        window.auth = auth;
        window.firebaseModules = {
            collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy,
            signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged
        };
    </script>
    <style>
        body {
            box-sizing: border-box;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .sidebar-item:hover { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-processed { background: #d1fae5; color: #065f46; }
        .status-urgent { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sidebar -->
    <div id="sidebar" class="fixed left-0 top-0 h-full w-64 bg-white shadow-lg z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300">
        <div class="p-6 gradient-bg text-white">
            <div class="flex items-center space-x-3 mb-2">
                <img src="https://iili.io/KdXnlX2.png" alt="Logo STAI" class="h-8 w-auto" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                <span class="text-xl hidden">üìß</span>
                <h1 class="text-xl font-bold">SiPersurat</h1>
            </div>
            <p class="text-sm opacity-90">Sistem Persuratan Digital</p>
        </div>
        
        <nav class="mt-6">
            <div class="px-4 space-y-2">
                <button onclick="showPage('dashboard')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:text-white transition-all duration-200 flex items-center space-x-3">
                    <span>üìä</span><span>Dashboard</span>
                </button>
                <button onclick="showPage('surat-masuk')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:text-white transition-all duration-200 flex items-center space-x-3">
                    <span>üì•</span><span>Surat Masuk</span>
                </button>
                <button onclick="showPage('surat-keluar')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:text-white transition-all duration-200 flex items-center space-x-3">
                    <span>üì§</span><span>Surat Keluar</span>
                </button>
                <button onclick="showPage('disposisi')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:text-white transition-all duration-200 flex items-center space-x-3">
                    <span>üìã</span><span>Disposisi</span>
                </button>
                <button onclick="showPage('arsip')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:text-white transition-all duration-200 flex items-center space-x-3">
                    <span>üîç</span><span>Pencarian & Arsip</span>
                </button>
                <button onclick="showPage('laporan')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:text-white transition-all duration-200 flex items-center space-x-3">
                    <span>üìà</span><span>Laporan</span>
                </button>
                <button onclick="showPage('pengguna')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-700 hover:text-white transition-all duration-200 flex items-center space-x-3">
                    <span>‚öôÔ∏è</span><span>Manajemen User</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Mobile Menu Button -->
    <button id="mobile-menu-btn" class="lg:hidden fixed top-4 left-4 z-50 bg-white p-2 rounded-lg shadow-lg">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
    </button>

    <!-- Main Content -->
    <div class="lg:ml-64 min-h-screen pt-16">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b px-6 py-4">
            <div class="flex justify-between items-center">
                <h2 id="page-title" class="text-2xl font-semibold text-gray-800">Dashboard</h2>
                <div class="flex items-center space-x-4">
                    <button id="sync-button" onclick="manualSync()" class="flex items-center space-x-2 text-white bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition-colors shadow-md font-medium" title="Test & Sinkronkan data dengan Google Sheets">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span>üîÑ Test Koneksi API</span>
                    </button>
                    <button id="firebase-sync-button" onclick="syncToFirebase()" class="flex items-center space-x-2 text-white bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded-lg transition-colors shadow-md font-medium" title="Sinkronkan data lokal ke Firebase">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                        </svg>
                        <span>üî• Sync Firebase</span>
                    </button>
                    <div class="flex items-center space-x-2">
                        <div id="last-sync-info" class="text-xs text-gray-500"></div>
                        <span id="user-welcome" class="text-sm text-gray-600">Selamat datang, Admin</span>
                        <div class="w-8 h-8 bg-gradient-to-r from-purple-400 to-pink-400 rounded-full"></div>
                        <button id="logout-button" onclick="logout()" class="text-red-600 hover:text-red-800 text-sm bg-red-50 hover:bg-red-100 px-3 py-2 rounded-lg transition-colors" title="Keluar dari sistem">
                            üö™ Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dashboard Page -->
        <div id="dashboard-page" class="p-6">
            <!-- Sync Status Banner -->
            <div id="sync-status-banner" class="bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-lg p-4 mb-6 shadow-lg hidden">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="animate-pulse">üîÑ</div>
                        <div>
                            <p class="font-medium">Data Real-time Aktif</p>
                            <p class="text-sm opacity-90">Sistem terhubung dengan Google Sheets - Data selalu terupdate</p>
                        </div>
                    </div>
                    <button onclick="hideSyncBanner()" class="text-white hover:text-gray-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Institutional Header -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl p-8 mb-8 text-center shadow-lg">
                <div class="mb-4">
                    <div class="mb-4 flex justify-center">
                        <img src="https://iili.io/KdXnlX2.png" alt="Logo STAI Al-Mas'udiyah" class="h-16 w-auto" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div class="text-4xl hidden">üèõÔ∏è</div>
                    </div>
                    <h1 class="text-3xl font-bold mb-2">SISTEM PERSURATAN DIGITAL</h1>
                    <h2 class="text-xl font-semibold mb-1">STAI AL-MAS'UDIYAH SUKABUMI</h2>
                    <div class="w-24 h-1 bg-white mx-auto rounded-full opacity-80"></div>
                </div>
                <p class="text-blue-100 text-sm">
                    Sistem Manajemen Persuratan Terintegrasi untuk Efisiensi Administrasi
                </p>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="card-hover bg-white p-6 rounded-xl shadow-sm border transition-all duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Surat Masuk Hari Ini</p>
                            <p id="stat-surat-masuk-hari-ini" class="text-3xl font-bold text-blue-600">0</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <span class="text-2xl">üì•</span>
                        </div>
                    </div>
                </div>
                
                <div class="card-hover bg-white p-6 rounded-xl shadow-sm border transition-all duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Surat Keluar Hari Ini</p>
                            <p id="stat-surat-keluar-hari-ini" class="text-3xl font-bold text-green-600">0</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <span class="text-2xl">üì§</span>
                        </div>
                    </div>
                </div>
                
                <div class="card-hover bg-white p-6 rounded-xl shadow-sm border transition-all duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Menunggu Disposisi</p>
                            <p id="stat-menunggu-disposisi" class="text-3xl font-bold text-orange-600">0</p>
                        </div>
                        <div class="bg-orange-100 p-3 rounded-full">
                            <span class="text-2xl">‚è≥</span>
                        </div>
                    </div>
                </div>
                
                <div class="card-hover bg-white p-6 rounded-xl shadow-sm border transition-all duration-300">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Total Arsip</p>
                            <p id="stat-total-arsip" class="text-3xl font-bold text-purple-600">0</p>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-full">
                            <span class="text-2xl">üìÅ</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts and Recent Activity -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Chart -->
                <div class="bg-white p-6 rounded-xl shadow-sm border">
                    <h3 class="text-lg font-semibold mb-4">Statistik Surat Bulanan</h3>
                    <canvas id="monthlyChart" width="400" height="200"></canvas>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white p-6 rounded-xl shadow-sm border">
                    <h3 class="text-lg font-semibold mb-4">Aktivitas Terbaru</h3>
                    <div id="recent-activity-container" class="space-y-4">
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-4">üìã</div>
                            <p>Belum ada aktivitas hari ini</p>
                            <p class="text-sm mt-2">Aktivitas akan muncul setelah ada surat masuk/keluar</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Institutional Footer -->
            <div class="bg-white rounded-xl shadow-sm border p-6 mt-8 text-center">
                <div class="flex flex-col md:flex-row justify-center items-center space-y-2 md:space-y-0 md:space-x-8 text-gray-600">
                    <div class="flex items-center space-x-2">
                        <span class="text-blue-600">üåê</span>
                        <span class="text-sm"><strong>Web:</strong> staimas.co.nr</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-green-600">üìç</span>
                        <span class="text-sm"><strong>Alamat:</strong> Jl. Raya Sagaranten Km. 26 Kp. Buniayu Desa Kertaangsana Nyalindung</span>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <p class="text-xs text-gray-500">¬© 2024 STAI Al-Mas'udiyah Sukabumi - Sistem Persuratan Digital</p>
                </div>
            </div>
        </div>

        <!-- Surat Masuk Page -->
        <div id="surat-masuk-page" class="p-6 hidden">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold">Manajemen Surat Masuk</h3>
                <div class="flex space-x-3">
                    <button onclick="openGoogleDrive()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12.01 2C6.5 2 2.01 6.5 2.01 12s4.49 10 9.99 10c5.51 0 10.01-4.5 10.01-10s-4.5-10-10-10zM13.5 6L10 10.5l1.5 1.5L15 8.5 13.5 6zM9.5 8.5L8 10l1.5 1.5L11 10 9.5 8.5z"/>
                        </svg>
                        <span>üìÅ Google Drive</span>
                    </button>
                    <button id="add-surat-masuk-btn" onclick="showModal('modal-surat-masuk')" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition-opacity">
                        + Tambah Surat Masuk
                    </button>
                </div>
            </div>

            <!-- Filter -->
            <div class="bg-white p-4 rounded-lg shadow-sm border mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="date" class="border rounded-lg px-3 py-2" placeholder="Tanggal Mulai">
                    <input type="date" class="border rounded-lg px-3 py-2" placeholder="Tanggal Akhir">
                    <select class="border rounded-lg px-3 py-2">
                        <option>Semua Status</option>
                        <option>Menunggu</option>
                        <option>Diproses</option>
                        <option>Selesai</option>
                    </select>
                    <input type="text" class="border rounded-lg px-3 py-2" placeholder="Cari pengirim...">
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">No. Surat</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pengirim</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Klasifikasi</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Perihal</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">File</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="surat-masuk-table-body" class="divide-y divide-gray-200">
                        <!-- Data akan diisi secara dinamis -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Surat Keluar Page -->
        <div id="surat-keluar-page" class="p-6 hidden">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold">Manajemen Surat Keluar</h3>
                <div class="flex space-x-3">
                    <button onclick="openGoogleDrive()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12.01 2C6.5 2 2.01 6.5 2.01 12s4.49 10 9.99 10c5.51 0 10.01-4.5 10.01-10s-4.5-10-10-10zM13.5 6L10 10.5l1.5 1.5L15 8.5 13.5 6zM9.5 8.5L8 10l1.5 1.5L11 10 9.5 8.5z"/>
                        </svg>
                        <span>üìÅ Google Drive</span>
                    </button>
                    <button id="add-surat-keluar-btn" onclick="showModal('modal-surat-keluar')" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition-opacity">
                        + Tambah Surat Keluar
                    </button>
                </div>
            </div>

            <!-- Filter -->
            <div class="bg-white p-4 rounded-lg shadow-sm border mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="date" class="border rounded-lg px-3 py-2" placeholder="Tanggal Mulai">
                    <input type="date" class="border rounded-lg px-3 py-2" placeholder="Tanggal Akhir">
                    <select class="border rounded-lg px-3 py-2">
                        <option>Semua Klasifikasi</option>
                        <option>Biasa</option>
                        <option>Penting</option>
                        <option>Rahasia</option>
                    </select>
                    <input type="text" class="border rounded-lg px-3 py-2" placeholder="Cari penerima...">
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">No. Surat</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Penerima</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Klasifikasi</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tingkat</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Perihal</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">File</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="surat-keluar-table-body" class="divide-y divide-gray-200">
                        <!-- Data akan diisi secara dinamis -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Disposisi Page -->
        <div id="disposisi-page" class="p-6 hidden">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold">üìã Manajemen Disposisi</h3>
                <div class="flex space-x-2">
                    <button onclick="refreshDisposisiData()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        üîÑ Refresh Data
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="bg-white p-4 rounded-lg shadow-sm border">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Menunggu Disposisi</p>
                            <p id="stat-menunggu-disposisi-page" class="text-2xl font-bold text-orange-600">0</p>
                        </div>
                        <div class="bg-orange-100 p-3 rounded-full">
                            <span class="text-xl">‚è≥</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded-lg shadow-sm border">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Sudah Didisposisi</p>
                            <p id="stat-sudah-disposisi" class="text-2xl font-bold text-green-600">0</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <span class="text-xl">‚úÖ</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded-lg shadow-sm border">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Prioritas Tinggi</p>
                            <p id="stat-prioritas-tinggi" class="text-2xl font-bold text-red-600">0</p>
                        </div>
                        <div class="bg-red-100 p-3 rounded-full">
                            <span class="text-xl">üî¥</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded-lg shadow-sm border">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Disposisi Hari Ini</p>
                            <p id="stat-disposisi-hari-ini" class="text-2xl font-bold text-blue-600">0</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <span class="text-xl">üìã</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter -->
            <div class="bg-white p-4 rounded-lg shadow-sm border mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <select id="filter-status-disposisi" class="border rounded-lg px-3 py-2" onchange="filterDisposisi()">
                        <option value="">Semua Status</option>
                        <option value="Menunggu Disposisi">Menunggu Disposisi</option>
                        <option value="Diproses">Sudah Didisposisi</option>
                        <option value="Selesai">Selesai</option>
                    </select>
                    <select id="filter-prioritas" class="border rounded-lg px-3 py-2" onchange="filterDisposisi()">
                        <option value="">Semua Prioritas</option>
                        <option value="Sangat Tinggi">Sangat Tinggi</option>
                        <option value="Tinggi">Tinggi</option>
                        <option value="Sedang">Sedang</option>
                        <option value="Rendah">Rendah</option>
                    </select>
                    <select id="filter-penerima-disposisi" class="border rounded-lg px-3 py-2" onchange="filterDisposisi()">
                        <option value="">Semua Penerima</option>
                        <option value="Ketua">Ketua</option>
                        <option value="PK 1">PK 1</option>
                        <option value="PK 2">PK 2</option>
                        <option value="PK 3">PK 3</option>
                        <option value="Ketua LPM">Ketua LPM</option>
                        <option value="Ketua LPPM">Ketua LPPM</option>
                        <option value="Ketua Prodi HES (M)">Ketua Prodi HES (M)</option>
                        <option value="Ketua Prodi PAI">Ketua Prodi PAI</option>
                        <option value="Sekretaris Prodi PAI">Sekretaris Prodi PAI</option>
                        <option value="Sekretaris Prodi HES (M)">Sekretaris Prodi HES (M)</option>
                    </select>
                    <input type="text" id="filter-search-disposisi" class="border rounded-lg px-3 py-2" placeholder="Cari nomor surat..." onkeyup="filterDisposisi()">
                </div>
            </div>

            <!-- Disposisi Table -->
            <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">No. Surat</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pengirim</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Perihal</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Disposisi Kepada</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Prioritas</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="disposisi-table-body" class="divide-y divide-gray-200">
                        <!-- Data akan diisi secara dinamis -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Arsip Page -->
        <div id="arsip-page" class="p-6 hidden">
            <h3 class="text-xl font-semibold mb-6">Pencarian & Arsip</h3>
            
            <!-- Advanced Search -->
            <div class="bg-white p-6 rounded-lg shadow-sm border mb-6">
                <h4 class="text-lg font-medium mb-4">Pencarian Lanjutan</h4>
                <form id="search-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" id="search-nomor" class="border rounded-lg px-3 py-2" placeholder="Nomor surat...">
                    <input type="text" id="search-perihal" class="border rounded-lg px-3 py-2" placeholder="Kata kunci perihal...">
                    <select id="search-jenis" class="border rounded-lg px-3 py-2">
                        <option value="">Semua Jenis</option>
                        <option value="masuk">Surat Masuk</option>
                        <option value="keluar">Surat Keluar</option>
                    </select>
                    <input type="date" id="search-tanggal-mulai" class="border rounded-lg px-3 py-2" placeholder="Tanggal Mulai">
                    <input type="date" id="search-tanggal-akhir" class="border rounded-lg px-3 py-2" placeholder="Tanggal Akhir">
                    <button type="submit" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition-opacity">
                        üîç Cari
                    </button>
                </form>
                <div class="mt-4">
                    <button onclick="clearSearch()" class="text-gray-600 hover:text-gray-800 text-sm">üóëÔ∏è Bersihkan Pencarian</button>
                    <button onclick="showAllDocuments()" class="text-blue-600 hover:text-blue-800 text-sm ml-4">üìã Tampilkan Semua Dokumen</button>
                </div>
            </div>

            <!-- Search Results -->
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="p-4 border-b">
                    <h4 id="search-results-title" class="font-medium">Hasil Pencarian (0 dokumen ditemukan)</h4>
                </div>
                <div id="search-results-container" class="p-4">
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-4">üîç</div>
                        <p>Gunakan form pencarian di atas untuk mencari dokumen</p>
                        <p class="text-sm mt-2">Atau klik "Tampilkan Semua Dokumen" untuk melihat seluruh arsip</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Laporan Page -->
        <div id="laporan-page" class="p-6 hidden">
            <h3 class="text-xl font-semibold mb-6">Laporan & Statistik</h3>
            
            <!-- Report Options -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-white p-6 rounded-lg shadow-sm border text-center">
                    <div class="text-4xl mb-4">üìä</div>
                    <h4 class="font-medium mb-2">Laporan Harian</h4>
                    <p class="text-sm text-gray-600 mb-4">Statistik surat masuk dan keluar hari ini</p>
                    <button onclick="generateDailyReport()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition-opacity">
                        Generate
                    </button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border text-center">
                    <div class="text-4xl mb-4">üìà</div>
                    <h4 class="font-medium mb-2">Laporan Bulanan</h4>
                    <p class="text-sm text-gray-600 mb-4">Ringkasan aktivitas persuratan bulanan</p>
                    <button onclick="showModal('modal-monthly-report')" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition-opacity">
                        Generate
                    </button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border text-center">
                    <div class="text-4xl mb-4">üìã</div>
                    <h4 class="font-medium mb-2">Laporan Custom</h4>
                    <p class="text-sm text-gray-600 mb-4">Buat laporan sesuai kebutuhan</p>
                    <button onclick="showModal('modal-custom-report')" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition-opacity">
                        Buat
                    </button>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg">
                    <div class="text-2xl font-bold" id="report-total-masuk">0</div>
                    <div class="text-sm opacity-90">Total Surat Masuk</div>
                </div>
                <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg">
                    <div class="text-2xl font-bold" id="report-total-keluar">0</div>
                    <div class="text-sm opacity-90">Total Surat Keluar</div>
                </div>
                <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4 rounded-lg">
                    <div class="text-2xl font-bold" id="report-pending">0</div>
                    <div class="text-sm opacity-90">Menunggu Disposisi</div>
                </div>
                <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg">
                    <div class="text-2xl font-bold" id="report-processed">0</div>
                    <div class="text-sm opacity-90">Sudah Diproses</div>
                </div>
            </div>

            <!-- Charts Container -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Trend Chart -->
                <div class="bg-white p-6 rounded-lg shadow-sm border">
                    <h4 class="text-lg font-medium mb-4">Tren Surat 6 Bulan Terakhir</h4>
                    <canvas id="trendChart" width="400" height="200"></canvas>
                </div>

                <!-- Classification Chart -->
                <div class="bg-white p-6 rounded-lg shadow-sm border">
                    <h4 class="text-lg font-medium mb-4">Distribusi Klasifikasi Surat</h4>
                    <canvas id="classificationChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Report Results -->
            <div id="report-results" class="bg-white rounded-lg shadow-sm border hidden">
                <div class="p-4 border-b flex justify-between items-center">
                    <h4 class="font-medium">Hasil Laporan</h4>
                    <div class="space-x-2">
                        <button onclick="printReport()" class="text-blue-600 hover:text-blue-800 text-sm">üñ®Ô∏è Print</button>
                        <button onclick="exportReport()" class="text-green-600 hover:text-green-800 text-sm">üìä Export Excel</button>
                        <button onclick="hideReportResults()" class="text-gray-600 hover:text-gray-800 text-sm">‚úï Tutup</button>
                    </div>
                </div>
                <div id="report-content" class="p-6">
                    <!-- Report content will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Pengguna Page -->
        <div id="pengguna-page" class="p-6 hidden">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold">Manajemen Pengguna</h3>
                <button onclick="showModal('modal-user')" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition-opacity">
                    + Tambah Pengguna
                </button>
            </div>

            <!-- Users Table -->
            <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body" class="divide-y divide-gray-200">
                        <!-- Data akan diisi secara dinamis -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Detail Disposisi -->
    <div id="modal-detail-disposisi" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-4xl mx-4 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold">üìã Detail Lembar Disposisi</h3>
                <div class="flex space-x-2">
                    <button onclick="exportDisposisiToPDF()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm">
                        üìÑ Export PDF
                    </button>
                    <button onclick="hideModal('modal-detail-disposisi')" class="text-gray-500 hover:text-gray-700 text-xl">‚úï</button>
                </div>
            </div>
            
            <!-- Informasi Surat -->
            <div class="bg-blue-50 p-6 rounded-lg mb-6">
                <h4 class="font-semibold text-blue-800 mb-4 text-lg">üìÑ Informasi Surat</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-3">
                        <div>
                            <span class="font-medium text-gray-700">Nomor Surat:</span>
                            <span id="detail-nomor-surat" class="ml-2 text-gray-900 font-semibold"></span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Tanggal Surat:</span>
                            <span id="detail-tanggal-surat" class="ml-2 text-gray-900"></span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Tanggal Diterima:</span>
                            <span id="detail-tanggal-diterima" class="ml-2 text-gray-900"></span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Pengirim:</span>
                            <span id="detail-pengirim" class="ml-2 text-gray-900"></span>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <span class="font-medium text-gray-700">Klasifikasi:</span>
                            <span id="detail-klasifikasi" class="ml-2 text-gray-900"></span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Tingkat Kepentingan:</span>
                            <span id="detail-tingkat" class="ml-2 text-gray-900"></span>
                        </div>
                        <div class="md:col-span-2">
                            <span class="font-medium text-gray-700">Perihal:</span>
                            <div id="detail-perihal" class="ml-2 text-gray-900 mt-1 p-3 bg-white rounded border"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Informasi Disposisi -->
            <div class="bg-green-50 p-6 rounded-lg mb-6">
                <h4 class="font-semibold text-green-800 mb-4 text-lg">üìã Informasi Disposisi</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-3">
                        <div>
                            <span class="font-medium text-gray-700">Tanggal Disposisi:</span>
                            <span id="detail-tanggal-disposisi" class="ml-2 text-gray-900"></span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Disposisi Kepada:</span>
                            <span id="detail-disposisi-kepada" class="ml-2 text-gray-900 font-semibold"></span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Prioritas:</span>
                            <span id="detail-prioritas" class="ml-2 text-gray-900"></span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Status Tindak Lanjut:</span>
                            <span id="detail-status-tindak-lanjut" class="ml-2 text-gray-900"></span>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <span class="font-medium text-gray-700">Sifat Disposisi:</span>
                            <span id="detail-sifat-disposisi" class="ml-2 text-gray-900"></span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Batas Waktu:</span>
                            <span id="detail-batas-waktu" class="ml-2 text-gray-900"></span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Instruksi:</span>
                            <span id="detail-instruksi" class="ml-2 text-gray-900"></span>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <span class="font-medium text-gray-700">Catatan Disposisi:</span>
                    <div id="detail-catatan" class="ml-2 text-gray-900 mt-2 p-3 bg-white rounded border min-h-[60px]"></div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-end space-x-3 pt-4 border-t">
                <button onclick="exportDisposisiToPDF()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors">
                    üìÑ Download PDF
                </button>
                <button onclick="hideModal('modal-detail-disposisi')" class="px-6 py-2 border rounded-lg hover:bg-gray-50 transition-colors">
                    Tutup
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Surat Masuk -->
    <div id="modal-surat-masuk" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Tambah Surat Masuk</h3>
                <button onclick="hideModal('modal-surat-masuk')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <form id="form-surat-masuk" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="nomor-surat-masuk" class="block text-sm font-medium mb-1">Nomor Surat</label>
                        <input type="text" id="nomor-surat-masuk" name="nomorSurat" class="w-full border rounded-lg px-3 py-2" placeholder="001/SM/2024" required>
                    </div>
                    <div>
                        <label for="tanggal-surat-masuk" class="block text-sm font-medium mb-1">Tanggal Surat</label>
                        <input type="date" id="tanggal-surat-masuk" name="tanggalSurat" class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                    <div>
                        <label for="tanggal-diterima-masuk" class="block text-sm font-medium mb-1">Tanggal Diterima</label>
                        <input type="date" id="tanggal-diterima-masuk" name="tanggalDiterima" class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                    <div>
                        <label for="tingkat-kepentingan-masuk" class="block text-sm font-medium mb-1">Tingkat Kepentingan</label>
                        <select id="tingkat-kepentingan-masuk" name="tingkatKepentingan" class="w-full border rounded-lg px-3 py-2" required>
                            <option value="">Pilih Tingkat Kepentingan</option>
                            <option value="Biasa">Biasa</option>
                            <option value="Penting">Penting</option>
                            <option value="Rahasia">Rahasia</option>
                            <option value="Segera">Segera</option>
                        </select>
                    </div>
                    <div>
                        <label for="klasifikasi-masuk" class="block text-sm font-medium mb-1">Klasifikasi Surat</label>
                        <select id="klasifikasi-masuk" name="klasifikasi" class="w-full border rounded-lg px-3 py-2" required>
                            <option value="">Pilih Klasifikasi Surat</option>
                            <option value="Keputusan">Keputusan</option>
                            <option value="Perintah">Perintah</option>
                            <option value="Nota Dinas">Nota Dinas</option>
                            <option value="Tugas">Tugas</option>
                            <option value="Permohonan">Permohonan</option>
                            <option value="Undangan">Undangan</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="pengirim-masuk" class="block text-sm font-medium mb-1">Pengirim</label>
                    <input type="text" id="pengirim-masuk" name="pengirim" class="w-full border rounded-lg px-3 py-2" placeholder="Nama instansi/individu" required>
                </div>
                <div>
                    <label for="perihal-masuk" class="block text-sm font-medium mb-1">Perihal/Subjek</label>
                    <textarea id="perihal-masuk" name="perihal" class="w-full border rounded-lg px-3 py-2 h-20" placeholder="Ringkasan isi surat" required></textarea>
                </div>
                <div>
                    <label for="lampiran-masuk" class="block text-sm font-medium mb-1">Lampiran (PDF/JPG)</label>
                    <input type="file" id="lampiran-masuk" name="lampiran" class="w-full border rounded-lg px-3 py-2" accept=".pdf,.jpg,.jpeg,.png">
                    <p class="text-xs text-gray-500 mt-1">*File akan diupload ke Google Drive dan link akan disimpan di spreadsheet</p>
                    <p class="text-xs text-gray-400 mt-1">Maksimal 10MB - Format: PDF, JPG, JPEG, PNG</p>
                </div>
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" onclick="hideModal('modal-surat-masuk')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Batal
                    </button>
                    <button type="submit" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                        <span class="submit-text">Simpan</span>
                        <span class="loading-text hidden">Menyimpan...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Surat Keluar -->
    <div id="modal-surat-keluar" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Tambah Surat Keluar</h3>
                <button onclick="hideModal('modal-surat-keluar')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <form id="form-surat-keluar" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="nomor-surat-keluar" class="block text-sm font-medium mb-1">Nomor Surat</label>
                        <input type="text" id="nomor-surat-keluar" name="nomorSurat" class="w-full border rounded-lg px-3 py-2" placeholder="001/SK/2024" required>
                    </div>
                    <div>
                        <label for="tanggal-surat-keluar" class="block text-sm font-medium mb-1">Tanggal Surat</label>
                        <input type="date" id="tanggal-surat-keluar" name="tanggalSurat" class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="klasifikasi-keluar" class="block text-sm font-medium mb-1">Klasifikasi Surat</label>
                        <select id="klasifikasi-keluar" name="klasifikasi" class="w-full border rounded-lg px-3 py-2" required>
                            <option value="">Pilih Klasifikasi Surat</option>
                            <option value="Keputusan">Keputusan</option>
                            <option value="Perintah">Perintah</option>
                            <option value="Nota Dinas">Nota Dinas</option>
                            <option value="Tugas">Tugas</option>
                            <option value="Permohonan">Permohonan</option>
                            <option value="Undangan">Undangan</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                    </div>
                    <div>
                        <label for="tingkat-kepentingan-keluar" class="block text-sm font-medium mb-1">Tingkat Kepentingan</label>
                        <select id="tingkat-kepentingan-keluar" name="tingkatKepentingan" class="w-full border rounded-lg px-3 py-2" required>
                            <option value="">Pilih Tingkat Kepentingan</option>
                            <option value="Biasa">Biasa</option>
                            <option value="Penting">Penting</option>
                            <option value="Rahasia">Rahasia</option>
                            <option value="Segera">Segera</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="penerima-keluar" class="block text-sm font-medium mb-1">Penerima</label>
                    <input type="text" id="penerima-keluar" name="penerima" class="w-full border rounded-lg px-3 py-2" placeholder="Nama instansi/individu tujuan" required>
                </div>
                <div>
                    <label for="perihal-keluar" class="block text-sm font-medium mb-1">Perihal/Subjek</label>
                    <textarea id="perihal-keluar" name="perihal" class="w-full border rounded-lg px-3 py-2 h-20" placeholder="Ringkasan isi surat" required></textarea>
                </div>
                <div>
                    <label for="lampiran-keluar" class="block text-sm font-medium mb-1">Lampiran (PDF/JPG)</label>
                    <input type="file" id="lampiran-keluar" name="lampiran" class="w-full border rounded-lg px-3 py-2" accept=".pdf,.jpg,.jpeg,.png">
                    <p class="text-xs text-gray-500 mt-1">*File akan diupload ke Google Drive dan link akan disimpan di spreadsheet</p>
                    <p class="text-xs text-gray-400 mt-1">Maksimal 10MB - Format: PDF, JPG, JPEG, PNG</p>
                </div>
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" onclick="hideModal('modal-surat-keluar')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Batal
                    </button>
                    <button type="submit" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                        <span class="submit-text">Simpan</span>
                        <span class="loading-text hidden">Menyimpan...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal User -->
    <div id="modal-user" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Tambah Pengguna</h3>
                <button onclick="hideModal('modal-user')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <form id="form-user" class="space-y-4">
                <div>
                    <label for="nama-user" class="block text-sm font-medium mb-1">Nama Lengkap</label>
                    <input type="text" id="nama-user" name="nama" class="w-full border rounded-lg px-3 py-2" placeholder="Nama lengkap" required>
                </div>
                <div>
                    <label for="email-user" class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" id="email-user" name="email" class="w-full border rounded-lg px-3 py-2" placeholder="email@domain.com" required>
                </div>
                <div>
                    <label for="role-user" class="block text-sm font-medium mb-1">Role</label>
                    <select id="role-user" name="role" class="w-full border rounded-lg px-3 py-2" required>
                        <option value="">Pilih Role</option>
                        <option value="Admin">Admin</option>
                        <option value="Staf">Staf</option>
                        <option value="Pimpinan">Pimpinan</option>
                    </select>
                </div>
                <div>
                    <label for="password-user" class="block text-sm font-medium mb-1">Password</label>
                    <input type="password" id="password-user" name="password" class="w-full border rounded-lg px-3 py-2" placeholder="Password" required>
                    <p class="text-xs text-gray-500 mt-1">Minimal 6 karakter</p>
                </div>
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" onclick="hideModal('modal-user')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Batal
                    </button>
                    <button type="submit" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Monthly Report -->
    <div id="modal-monthly-report" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Laporan Bulanan</h3>
                <button onclick="hideModal('modal-monthly-report')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <form id="form-monthly-report" class="space-y-4">
                <div>
                    <label for="month-report" class="block text-sm font-medium mb-1">Pilih Bulan</label>
                    <input type="month" id="month-report" name="month" class="w-full border rounded-lg px-3 py-2" required>
                </div>
                <div>
                    <label for="report-type" class="block text-sm font-medium mb-1">Jenis Laporan</label>
                    <select id="report-type" name="reportType" class="w-full border rounded-lg px-3 py-2" required>
                        <option value="">Pilih Jenis Laporan</option>
                        <option value="summary">Ringkasan Bulanan</option>
                        <option value="detailed">Detail Lengkap</option>
                        <option value="classification">Per Klasifikasi</option>
                        <option value="status">Per Status</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" onclick="hideModal('modal-monthly-report')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Batal
                    </button>
                    <button type="submit" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                        Generate Laporan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Custom Report -->
    <div id="modal-custom-report" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Laporan Custom</h3>
                <button onclick="hideModal('modal-custom-report')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <form id="form-custom-report" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="start-date-report" class="block text-sm font-medium mb-1">Tanggal Mulai</label>
                        <input type="date" id="start-date-report" name="startDate" class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                    <div>
                        <label for="end-date-report" class="block text-sm font-medium mb-1">Tanggal Akhir</label>
                        <input type="date" id="end-date-report" name="endDate" class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                </div>
                <div>
                    <label for="letter-type-report" class="block text-sm font-medium mb-1">Jenis Surat</label>
                    <select id="letter-type-report" name="letterType" class="w-full border rounded-lg px-3 py-2" required>
                        <option value="">Pilih Jenis Surat</option>
                        <option value="all">Semua Surat</option>
                        <option value="masuk">Surat Masuk Saja</option>
                        <option value="keluar">Surat Keluar Saja</option>
                    </select>
                </div>
                <div>
                    <label for="classification-report" class="block text-sm font-medium mb-1">Klasifikasi</label>
                    <select id="classification-report" name="classification" class="w-full border rounded-lg px-3 py-2">
                        <option value="">Semua Klasifikasi</option>
                        <option value="Keputusan">Keputusan</option>
                        <option value="Perintah">Perintah</option>
                        <option value="Nota Dinas">Nota Dinas</option>
                        <option value="Tugas">Tugas</option>
                        <option value="Permohonan">Permohonan</option>
                        <option value="Undangan">Undangan</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                </div>
                <div>
                    <label for="status-report" class="block text-sm font-medium mb-1">Status (Khusus Surat Masuk)</label>
                    <select id="status-report" name="status" class="w-full border rounded-lg px-3 py-2">
                        <option value="">Semua Status</option>
                        <option value="Menunggu Disposisi">Menunggu Disposisi</option>
                        <option value="Diproses">Diproses</option>
                        <option value="Selesai">Selesai</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" onclick="hideModal('modal-custom-report')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Batal
                    </button>
                    <button type="submit" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                        Generate Laporan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Disposisi -->
    <div id="modal-disposisi" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">üìã Form Disposisi Surat</h3>
                <button onclick="hideModal('modal-disposisi')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            
            <!-- Informasi Surat -->
            <div class="bg-blue-50 p-4 rounded-lg mb-6">
                <h4 class="font-medium text-blue-800 mb-3">üìÑ Informasi Surat</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="font-medium text-gray-700">Nomor Surat:</span>
                        <span id="disposisi-nomor-surat" class="ml-2 text-gray-900"></span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Tanggal:</span>
                        <span id="disposisi-tanggal" class="ml-2 text-gray-900"></span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Pengirim:</span>
                        <span id="disposisi-pengirim" class="ml-2 text-gray-900"></span>
                    </div>
                    <div class="md:col-span-2">
                        <span class="font-medium text-gray-700">Perihal:</span>
                        <span id="disposisi-perihal" class="ml-2 text-gray-900"></span>
                    </div>
                </div>
            </div>
            
            <form id="form-disposisi" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="tanggal-disposisi" class="block text-sm font-medium mb-1">Tanggal Disposisi</label>
                        <input type="date" id="tanggal-disposisi" name="tanggalDisposisi" class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                    <div>
                        <label for="prioritas-disposisi" class="block text-sm font-medium mb-1">Prioritas</label>
                        <select id="prioritas-disposisi" name="prioritas" class="w-full border rounded-lg px-3 py-2" required>
                            <option value="">Pilih Prioritas</option>
                            <option value="Rendah">üü¢ Rendah</option>
                            <option value="Sedang">üü° Sedang</option>
                            <option value="Tinggi">üü† Tinggi</option>
                            <option value="Sangat Tinggi">üî¥ Sangat Tinggi</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label for="disposisi-kepada-select" class="block text-sm font-medium mb-1">Disposisi Kepada</label>
                    <select name="disposisiKepada" id="disposisi-kepada-select" class="w-full border rounded-lg px-3 py-2" required onchange="toggleManualInput()">
                        <option value="">Pilih Penerima Disposisi</option>
                        <option value="Ketua">Ketua</option>
                        <option value="PK 1">PK 1</option>
                        <option value="PK 2">PK 2</option>
                        <option value="PK 3">PK 3</option>
                        <option value="Ketua LPM">Ketua LPM</option>
                        <option value="Ketua LPPM">Ketua LPPM</option>
                        <option value="Ketua Prodi HES (M)">Ketua Prodi HES (M)</option>
                        <option value="Ketua Prodi PAI">Ketua Prodi PAI</option>
                        <option value="Sekretaris Prodi PAI">Sekretaris Prodi PAI</option>
                        <option value="Sekretaris Prodi HES (M)">Sekretaris Prodi HES (M)</option>
                        <option value="Lainnya">Lainnya (Ketik Manual)</option>
                    </select>
                </div>
                
                <!-- Manual Input Field -->
                <div id="manual-disposisi-input" class="hidden">
                    <label for="manual-disposisi-kepada" class="block text-sm font-medium mb-1">Tujuan Disposisi (Manual)</label>
                    <input type="text" id="manual-disposisi-kepada" class="w-full border rounded-lg px-3 py-2" placeholder="Ketik tujuan disposisi..." maxlength="100">
                    <p class="text-xs text-gray-500 mt-1">Contoh: Kepala Bagian Keuangan, Tim IT, Koordinator Akademik, dll.</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Instruksi Disposisi</label>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-3">
                        <label class="flex items-center space-x-2 text-sm">
                            <input type="checkbox" name="instruksi" value="Untuk diketahui" class="rounded">
                            <span>Untuk diketahui</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm">
                            <input type="checkbox" name="instruksi" value="Untuk ditindaklanjuti" class="rounded">
                            <span>Untuk ditindaklanjuti</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm">
                            <input type="checkbox" name="instruksi" value="Untuk diproses" class="rounded">
                            <span>Untuk diproses</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm">
                            <input type="checkbox" name="instruksi" value="Untuk dipelajari" class="rounded">
                            <span>Untuk dipelajari</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm">
                            <input type="checkbox" name="instruksi" value="Untuk dilaksanakan" class="rounded">
                            <span>Untuk dilaksanakan</span>
                        </label>
                        <label class="flex items-center space-x-2 text-sm">
                            <input type="checkbox" name="instruksi" value="Untuk koordinasi" class="rounded">
                            <span>Untuk koordinasi</span>
                        </label>
                    </div>
                </div>
                
                <div>
                    <label for="catatan-disposisi" class="block text-sm font-medium mb-1">Catatan Disposisi</label>
                    <textarea id="catatan-disposisi" name="catatanDisposisi" class="w-full border rounded-lg px-3 py-2 h-24" placeholder="Tambahkan catatan atau instruksi khusus..." required></textarea>
                </div>
                
                <div>
                    <label for="batas-waktu-disposisi" class="block text-sm font-medium mb-1">Batas Waktu Penyelesaian</label>
                    <input type="date" id="batas-waktu-disposisi" name="batasWaktu" class="w-full border rounded-lg px-3 py-2">
                    <p class="text-xs text-gray-500 mt-1">Opsional - Kosongkan jika tidak ada batas waktu khusus</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="status-tindak-lanjut" class="block text-sm font-medium mb-1">Status Tindak Lanjut</label>
                        <select id="status-tindak-lanjut" name="statusTindakLanjut" class="w-full border rounded-lg px-3 py-2" required>
                            <option value="">Pilih Status</option>
                            <option value="Segera">Segera</option>
                            <option value="Normal">Normal</option>
                            <option value="Dapat Ditunda">Dapat Ditunda</option>
                        </select>
                    </div>
                    <div>
                        <label for="sifat-disposisi" class="block text-sm font-medium mb-1">Sifat Disposisi</label>
                        <select id="sifat-disposisi" name="sifatDisposisi" class="w-full border rounded-lg px-3 py-2" required>
                            <option value="">Pilih Sifat</option>
                            <option value="Rahasia">Rahasia</option>
                            <option value="Penting">Penting</option>
                            <option value="Biasa">Biasa</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-2 pt-4 border-t">
                    <button type="button" onclick="hideModal('modal-disposisi')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Batal
                    </button>
                    <button type="submit" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                        <span class="submit-text">üíæ Simpan Disposisi</span>
                        <span class="loading-text hidden">Menyimpan...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Login -->
    <div id="modal-login" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-8 w-full max-w-md mx-4 shadow-2xl">
            <div class="text-center mb-6">
                <div class="mb-4 flex justify-center">
                    <img src="https://iili.io/KdXnlX2.png" alt="Logo STAI Al-Mas'udiyah" class="h-12 w-auto" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div class="text-4xl hidden">üèõÔ∏è</div>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Login Sistem</h2>
                <p class="text-gray-600">STAI Al-Mas'udiyah Sukabumi</p>
                <p class="text-sm text-gray-500 mt-2">Masuk untuk mengakses fitur manajemen</p>
            </div>
            
            <form id="form-login" class="space-y-4">
                <div>
                    <label for="email-login" class="block text-sm font-medium mb-2 text-gray-700">Email</label>
                    <input type="email" id="email-login" name="email" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan email Anda" required>
                </div>
                <div>
                    <label for="password-login" class="block text-sm font-medium mb-2 text-gray-700">Password</label>
                    <input type="password" id="password-login" name="password" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan password Anda" required>
                </div>
                
                <div id="login-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                    <div class="flex items-center">
                        <span class="mr-2">‚ö†Ô∏è</span>
                        <span>Email atau password salah!</span>
                    </div>
                </div>
                
                <button type="submit" class="w-full gradient-bg text-white py-3 rounded-lg hover:opacity-90 transition-opacity font-medium">
                    <span class="login-text">üîê Masuk</span>
                    <span class="login-loading hidden">Memverifikasi...</span>
                </button>
                
                <div class="text-center mt-4">
                    <button type="button" onclick="showPublicView()" class="text-blue-600 hover:text-blue-800 text-sm underline">
                        üëÅÔ∏è Lihat sebagai Publik
                    </button>
                </div>
            </form>
            
            <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                <h4 class="text-sm font-medium text-blue-800 mb-2">Demo Login:</h4>
                <div class="text-xs text-blue-700 space-y-1">
                    <p><strong>Admin:</strong> admin@sipersurat.com / admin123</p>
                    <p><strong>Staf:</strong> staf@sipersurat.com / staf123</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Public View Notice -->
    <div id="public-view-notice" class="fixed top-0 left-0 right-0 bg-gradient-to-r from-blue-600 to-purple-600 text-white p-3 z-40 hidden">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <span class="text-lg">üëÅÔ∏è</span>
                <div>
                    <p class="font-medium">Mode Tampilan Publik</p>
                    <p class="text-sm opacity-90">Anda melihat data dalam mode baca saja</p>
                </div>
            </div>
            <button onclick="showLoginModal()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                üîê Login untuk Mengelola
            </button>
        </div>
    </div>

    <script>
        // Google Sheets & Drive Configuration
        const GOOGLE_CONFIG = {
            SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbyAvoHoJ_Yb62ZCrtF_zby25Fh4KXcpesVB1EFvNAqdIJD2zbmEh0rupZ60UhNXTYnc/exec',
            SPREADSHEET_ID: '1GcGNLXeSLORiiEOj4NMqdVWIPK9eayd51zueOI7zPZg',
            DRIVE_FOLDER_ID: '1HY4wJzmMe4jI8TMOLOXyPuongfZgYO78',
            DRIVE_FOLDER_URL: 'https://drive.google.com/drive/folders/1HY4wJzmMe4jI8TMOLOXyPuongfZgYO78'
        };

        // File Upload Helper Functions
        const FileUploadHelper = {
            // Upload file to Google Drive
            async uploadToGoogleDrive(file, fileName) {
                try {
                    // Validate file
                    if (!file) {
                        throw new Error('No file selected');
                    }
                    
                    // Check file size (max 10MB)
                    if (file.size > 10 * 1024 * 1024) {
                        throw new Error('File terlalu besar. Maksimal 10MB');
                    }
                    
                    // Check file type
                    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
                    if (!allowedTypes.includes(file.type)) {
                        throw new Error('Format file tidak didukung. Gunakan PDF, JPG, JPEG, atau PNG');
                    }
                    
                    // Convert file to base64
                    const base64Data = await this.fileToBase64(file);
                    
                    // Prepare upload data
                    const uploadData = {
                        action: 'upload-file',
                        fileName: fileName || file.name,
                        fileData: base64Data,
                        mimeType: file.type,
                        folderId: GOOGLE_CONFIG.DRIVE_FOLDER_ID
                    };
                    
                    // Upload to Google Drive via Apps Script
                    const response = await fetch(GOOGLE_CONFIG.SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(uploadData)
                    });
                    
                    if (!response.ok) {
                        throw new Error('Network error during upload');
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        return {
                            success: true,
                            fileId: result.fileId,
                            fileName: result.fileName,
                            fileUrl: result.fileUrl || `https://drive.google.com/file/d/${result.fileId}/view`,
                            message: 'File berhasil diupload ke Google Drive'
                        };
                    } else {
                        throw new Error(result.error || 'Upload failed');
                    }
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    return {
                        success: false,
                        error: error.message,
                        message: `Gagal upload file: ${error.message}`
                    };
                }
            },
            
            // Convert file to base64
            fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => {
                        // Remove data:mime/type;base64, prefix
                        const base64 = reader.result.split(',')[1];
                        resolve(base64);
                    };
                    reader.onerror = error => reject(error);
                });
            },
            
            // Show upload progress
            showUploadProgress(fileName) {
                const progressHtml = `
                    <div id="upload-progress" class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-blue-800">Mengupload file...</p>
                                <p class="text-xs text-blue-600">${fileName}</p>
                            </div>
                        </div>
                    </div>
                `;
                return progressHtml;
            },
            
            // Show upload success
            showUploadSuccess(fileName, fileUrl) {
                const successHtml = `
                    <div id="upload-success" class="mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="text-green-600">‚úÖ</div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-green-800">File berhasil diupload!</p>
                                <p class="text-xs text-green-600">${fileName}</p>
                                <a href="${fileUrl}" target="_blank" rel="noopener noreferrer" class="text-xs text-blue-600 hover:text-blue-800 underline">
                                    üìÅ Lihat di Google Drive
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                return successHtml;
            },
            
            // Show upload error
            showUploadError(error) {
                const errorHtml = `
                    <div id="upload-error" class="mt-3 p-3 bg-red-50 border border-red-200 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="text-red-600">‚ùå</div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-red-800">Upload gagal!</p>
                                <p class="text-xs text-red-600">${error}</p>
                            </div>
                        </div>
                    </div>
                `;
                return errorHtml;
            }
        };

        // Firebase Helper Functions
        const FirebaseHelper = {
            // Initialize Firebase listeners
            async initializeFirebase() {
                try {
                    // Wait for Firebase to be available
                    while (!window.db || !window.auth || !window.firebaseModules) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    console.log('üî• Firebase initialized successfully');
                    
                    // Setup auth state listener
                    window.firebaseModules.onAuthStateChanged(window.auth, (user) => {
                        if (user) {
                            console.log('User signed in:', user.email);
                            this.setupRealtimeListeners();
                        } else {
                            console.log('User signed out');
                        }
                    });
                    
                    return true;
                } catch (error) {
                    console.error('Firebase initialization error:', error);
                    showNotification('‚ö†Ô∏è Firebase tidak dapat terhubung, menggunakan penyimpanan lokal', 'warning');
                    return false;
                }
            },

            // Setup real-time listeners for data changes
            setupRealtimeListeners() {
                try {
                    const { onSnapshot, collection, query, orderBy } = window.firebaseModules;
                    
                    // Listen to surat masuk changes
                    const suratMasukQuery = query(collection(window.db, 'surat-masuk'), orderBy('timestamp', 'desc'));
                    onSnapshot(suratMasukQuery, (snapshot) => {
                        suratMasukData = [];
                        snapshot.forEach((doc) => {
                            suratMasukData.push({ id: doc.id, ...doc.data() });
                        });
                        localStorage.setItem('suratMasukData', JSON.stringify(suratMasukData));
                        if (document.getElementById('surat-masuk-table-body')) {
                            loadSuratMasukTable();
                        }
                        updateDashboardStats();
                    });

                    // Listen to surat keluar changes
                    const suratKeluarQuery = query(collection(window.db, 'surat-keluar'), orderBy('timestamp', 'desc'));
                    onSnapshot(suratKeluarQuery, (snapshot) => {
                        suratKeluarData = [];
                        snapshot.forEach((doc) => {
                            suratKeluarData.push({ id: doc.id, ...doc.data() });
                        });
                        localStorage.setItem('suratKeluarData', JSON.stringify(suratKeluarData));
                        if (document.getElementById('surat-keluar-table-body')) {
                            loadSuratKeluarTable();
                        }
                        updateDashboardStats();
                    });

                    // Listen to disposisi changes
                    const disposisiQuery = query(collection(window.db, 'disposisi'), orderBy('timestamp', 'desc'));
                    onSnapshot(disposisiQuery, (snapshot) => {
                        disposisiData = [];
                        snapshot.forEach((doc) => {
                            disposisiData.push({ id: doc.id, ...doc.data() });
                        });
                        localStorage.setItem('disposisiData', JSON.stringify(disposisiData));
                        if (document.getElementById('disposisi-table-body')) {
                            loadDisposisiTable();
                        }
                        updateDashboardStats();
                    });

                    console.log('üîÑ Real-time listeners setup complete');
                    showNotification('üî• Terhubung ke Firebase - Data real-time aktif!', 'success');
                    
                } catch (error) {
                    console.error('Error setting up listeners:', error);
                }
            },

            // Add document to Firebase
            async addDocument(collectionName, data) {
                try {
                    const { addDoc, collection } = window.firebaseModules;
                    const docRef = await addDoc(collection(window.db, collectionName), {
                        ...data,
                        timestamp: new Date().toISOString(),
                        createdBy: window.auth.currentUser?.email || 'anonymous'
                    });
                    console.log('Document added with ID:', docRef.id);
                    return docRef.id;
                } catch (error) {
                    console.error('Error adding document:', error);
                    throw error;
                }
            },

            // Update document in Firebase
            async updateDocument(collectionName, docId, data) {
                try {
                    const { updateDoc, doc } = window.firebaseModules;
                    await updateDoc(doc(window.db, collectionName, docId), {
                        ...data,
                        updatedAt: new Date().toISOString(),
                        updatedBy: window.auth.currentUser?.email || 'anonymous'
                    });
                    console.log('Document updated:', docId);
                } catch (error) {
                    console.error('Error updating document:', error);
                    throw error;
                }
            },

            // Delete document from Firebase
            async deleteDocument(collectionName, docId) {
                try {
                    const { deleteDoc, doc } = window.firebaseModules;
                    await deleteDoc(doc(window.db, collectionName, docId));
                    console.log('Document deleted:', docId);
                } catch (error) {
                    console.error('Error deleting document:', error);
                    throw error;
                }
            },

            // Load all data from Firebase
            async loadAllData() {
                try {
                    const { getDocs, collection, query, orderBy } = window.firebaseModules;
                    
                    // Load surat masuk
                    const suratMasukSnapshot = await getDocs(query(collection(window.db, 'surat-masuk'), orderBy('timestamp', 'desc')));
                    suratMasukData = [];
                    suratMasukSnapshot.forEach((doc) => {
                        suratMasukData.push({ id: doc.id, ...doc.data() });
                    });

                    // Load surat keluar
                    const suratKeluarSnapshot = await getDocs(query(collection(window.db, 'surat-keluar'), orderBy('timestamp', 'desc')));
                    suratKeluarData = [];
                    suratKeluarSnapshot.forEach((doc) => {
                        suratKeluarData.push({ id: doc.id, ...doc.data() });
                    });

                    // Load disposisi
                    const disposisiSnapshot = await getDocs(query(collection(window.db, 'disposisi'), orderBy('timestamp', 'desc')));
                    disposisiData = [];
                    disposisiSnapshot.forEach((doc) => {
                        disposisiData.push({ id: doc.id, ...doc.data() });
                    });

                    // Update localStorage
                    localStorage.setItem('suratMasukData', JSON.stringify(suratMasukData));
                    localStorage.setItem('suratKeluarData', JSON.stringify(suratKeluarData));
                    localStorage.setItem('disposisiData', JSON.stringify(disposisiData));

                    console.log('All data loaded from Firebase');
                    return true;
                } catch (error) {
                    console.error('Error loading data from Firebase:', error);
                    return false;
                }
            },

            // Sync local data to Firebase (for migration)
            async syncLocalToFirebase() {
                try {
                    const { addDoc, collection } = window.firebaseModules;
                    
                    // Sync surat masuk
                    for (const surat of suratMasukData) {
                        if (!surat.id || !surat.id.includes('firebase')) {
                            await addDoc(collection(window.db, 'surat-masuk'), surat);
                        }
                    }

                    // Sync surat keluar
                    for (const surat of suratKeluarData) {
                        if (!surat.id || !surat.id.includes('firebase')) {
                            await addDoc(collection(window.db, 'surat-keluar'), surat);
                        }
                    }

                    // Sync disposisi
                    for (const disposisi of disposisiData) {
                        if (!disposisi.id || !disposisi.id.includes('firebase')) {
                            await addDoc(collection(window.db, 'disposisi'), disposisi);
                        }
                    }

                    console.log('Local data synced to Firebase');
                    showNotification('‚úÖ Data lokal berhasil disinkronkan ke Firebase!', 'success');
                } catch (error) {
                    console.error('Error syncing to Firebase:', error);
                    showNotification('‚ùå Gagal sinkronisasi ke Firebase', 'error');
                }
            }
        };

        // Google Drive access function with alternatives
        function openGoogleDrive() {
            const driveUrl = GOOGLE_CONFIG.DRIVE_FOLDER_URL;
            
            // Try to open in new tab first
            const newWindow = window.open(driveUrl, '_blank', 'noopener,noreferrer');
            
            // Check if popup was blocked
            if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                // Show alternative modal if popup blocked
                showGoogleDriveAlternatives(driveUrl);
            } else {
                showNotification('üìÅ Membuka Google Drive di tab baru...', 'info');
            }
        }

        // Show alternatives if direct link fails
        function showGoogleDriveAlternatives(driveUrl) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-4">üìÅ</div>
                        <h3 class="text-lg font-semibold mb-2">Akses Google Drive</h3>
                        <p class="text-gray-600 text-sm">Pilih cara untuk mengakses folder Google Drive</p>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="copyDriveLink('${driveUrl}')" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            <span>Salin Link Drive</span>
                        </button>
                        
                        <button onclick="window.location.href='${driveUrl}'" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                            </svg>
                            <span>Buka di Tab Ini</span>
                        </button>
                        
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-600 mb-2"><strong>Link Manual:</strong></p>
                            <div class="bg-white p-2 rounded border text-xs font-mono break-all">${driveUrl}</div>
                        </div>
                        
                        <div class="bg-blue-50 p-3 rounded-lg">
                            <p class="text-xs text-blue-800"><strong>üí° Tips:</strong></p>
                            <p class="text-xs text-blue-700 mt-1">Jika link tidak terbuka, pastikan Anda sudah login ke Google Drive dan memiliki akses ke folder ini.</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-end mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition-colors">
                            Tutup
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Copy drive link to clipboard
        function copyDriveLink(url) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(url).then(() => {
                    showNotification('‚úÖ Link Google Drive berhasil disalin ke clipboard!', 'success');
                }).catch(() => {
                    fallbackCopyTextToClipboard(url);
                });
            } else {
                fallbackCopyTextToClipboard(url);
            }
        }

        // Fallback copy function for older browsers
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showNotification('‚úÖ Link Google Drive berhasil disalin!', 'success');
                } else {
                    showNotification('‚ùå Gagal menyalin link. Silakan salin manual.', 'error');
                }
            } catch (err) {
                showNotification('‚ùå Browser tidak mendukung copy otomatis. Silakan salin manual.', 'error');
            }
            
            document.body.removeChild(textArea);
        }

        // Authentication state
        let isLoggedIn = false;
        let currentUser = null;
        let isPublicView = true;

        // Data storage
        let suratMasukData = JSON.parse(localStorage.getItem('suratMasukData')) || [];
        let suratKeluarData = JSON.parse(localStorage.getItem('suratKeluarData')) || [];
        let disposisiData = JSON.parse(localStorage.getItem('disposisiData')) || [];
        let userData = JSON.parse(localStorage.getItem('userData')) || [
            {
                id: 1,
                nama: 'Admin Sistem',
                email: 'admin@sipersurat.com',
                password: 'admin123',
                role: 'Admin',
                status: 'Aktif',
                tanggalDibuat: new Date().toISOString()
            },
            {
                id: 2,
                nama: 'Staf Persuratan',
                email: 'staf@sipersurat.com',
                password: 'staf123',
                role: 'Staf',
                status: 'Aktif',
                tanggalDibuat: new Date().toISOString()
            }
        ];

        // Sync configuration
        let isDataSynced = false;
        let lastSyncTime = localStorage.getItem('lastSyncTime') || null;
        let currentDisposisiSurat = null;

        // Charts
        let monthlyChart = null;
        let trendChart = null;
        let classificationChart = null;

        // Notification function
        function showNotification(message, type = 'info') {
            const existingNotifications = document.querySelectorAll('.notification-toast');
            existingNotifications.forEach(n => n.remove());
            
            const colors = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'warning': 'bg-yellow-500',
                'info': 'bg-blue-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `notification-toast fixed top-20 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300`;
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">‚úï</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        // Test API connection
        async function testAPIConnection() {
            try {
                const testUrl = `${GOOGLE_CONFIG.SCRIPT_URL}?action=test&timestamp=${Date.now()}`;
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                
                const response = await fetch(testUrl, {
                    method: 'GET',
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const result = await response.json();
                    return result.success;
                }
                return false;
                
            } catch (error) {
                console.error('API connection error:', error);
                return false;
            }
        }

        // Firebase sync function
        async function syncToFirebase() {
            if (!requireAuth()) return;
            
            const syncButton = document.getElementById('firebase-sync-button');
            const originalText = syncButton.innerHTML;
            
            try {
                syncButton.innerHTML = `
                    <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span>üîÑ Syncing...</span>
                `;
                syncButton.disabled = true;
                
                if (!window.db) {
                    showNotification('‚ùå Firebase belum terhubung!', 'error');
                    return;
                }
                
                await FirebaseHelper.syncLocalToFirebase();
                
            } catch (error) {
                console.error('Error in Firebase sync:', error);
                showNotification('‚ùå Terjadi kesalahan saat sinkronisasi Firebase', 'error');
                
            } finally {
                syncButton.innerHTML = originalText;
                syncButton.disabled = false;
            }
        }

        // Manual sync function
        async function manualSync() {
            const syncButton = document.getElementById('sync-button');
            const originalText = syncButton.innerHTML;
            
            try {
                syncButton.innerHTML = `
                    <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span>‚è≥ Testing...</span>
                `;
                syncButton.disabled = true;
                
                showNotification('üîÑ Menguji koneksi API Google Apps Script...', 'info');
                
                const isConnected = await testAPIConnection();
                
                if (isConnected) {
                    syncButton.innerHTML = `
                        <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span>üì• Memuat Data...</span>
                    `;
                    
                    showNotification('‚úÖ Koneksi API berhasil! Memuat data dari Google Sheets...', 'success');
                    
                    const dataLoaded = await loadDataFromGoogleSheets();
                    
                    if (dataLoaded) {
                        showNotification('üéâ Test & Sinkronisasi berhasil! Data telah diperbarui dari Google Sheets.', 'success');
                        updateLastSyncInfo();
                    } else {
                        showNotification('‚ö†Ô∏è Koneksi API berhasil, tapi gagal memuat data dari Google Sheets.', 'warning');
                    }
                } else {
                    showNotification('‚ùå Test Koneksi Gagal! Periksa URL Google Apps Script dan pastikan sudah di-deploy dengan benar.', 'error');
                }
                
            } catch (error) {
                console.error('Error in manual sync:', error);
                showNotification('‚ùå Terjadi kesalahan saat test koneksi', 'error');
                
            } finally {
                syncButton.innerHTML = originalText;
                syncButton.disabled = false;
            }
        }

        // Load data from Google Sheets
        async function loadDataFromGoogleSheets() {
            try {
                // Load surat masuk
                const suratMasukUrl = `${GOOGLE_CONFIG.SCRIPT_URL}?action=get-surat-masuk&timestamp=${Date.now()}`;
                const suratMasukResponse = await fetch(suratMasukUrl);
                
                if (suratMasukResponse.ok) {
                    const suratMasukResult = await suratMasukResponse.json();
                    if (suratMasukResult.success && suratMasukResult.data) {
                        suratMasukData = suratMasukResult.data;
                        localStorage.setItem('suratMasukData', JSON.stringify(suratMasukData));
                    }
                }
                
                // Load surat keluar
                const suratKeluarUrl = `${GOOGLE_CONFIG.SCRIPT_URL}?action=get-surat-keluar&timestamp=${Date.now()}`;
                const suratKeluarResponse = await fetch(suratKeluarUrl);
                
                if (suratKeluarResponse.ok) {
                    const suratKeluarResult = await suratKeluarResponse.json();
                    if (suratKeluarResult.success && suratKeluarResult.data) {
                        suratKeluarData = suratKeluarResult.data;
                        localStorage.setItem('suratKeluarData', JSON.stringify(suratKeluarData));
                    }
                }
                
                lastSyncTime = new Date().toISOString();
                localStorage.setItem('lastSyncTime', lastSyncTime);
                isDataSynced = true;
                
                refreshAllDisplays();
                showSyncBanner();
                
                return true;
                
            } catch (error) {
                console.error('Error loading data from Google Sheets:', error);
                return false;
            }
        }

        // Update last sync info
        function updateLastSyncInfo() {
            const lastSyncElement = document.getElementById('last-sync-info');
            if (lastSyncTime && lastSyncElement) {
                const syncDate = new Date(lastSyncTime);
                const now = new Date();
                const diffMinutes = Math.floor((now - syncDate) / (1000 * 60));
                
                let timeText;
                if (diffMinutes < 1) {
                    timeText = 'Baru saja';
                } else if (diffMinutes < 60) {
                    timeText = `${diffMinutes} menit lalu`;
                } else if (diffMinutes < 1440) {
                    const hours = Math.floor(diffMinutes / 60);
                    timeText = `${hours} jam lalu`;
                } else {
                    timeText = syncDate.toLocaleDateString('id-ID');
                }
                
                lastSyncElement.textContent = `Sync terakhir: ${timeText}`;
            }
        }

        // Show/hide sync banner
        function showSyncBanner() {
            const banner = document.getElementById('sync-status-banner');
            if (banner) {
                banner.classList.remove('hidden');
            }
        }

        function hideSyncBanner() {
            const banner = document.getElementById('sync-status-banner');
            if (banner) {
                banner.classList.add('hidden');
            }
        }

        // Authentication functions
        function login(email, password) {
            console.log('Login attempt:', email, password);
            console.log('Available users:', userData);
            
            const user = userData.find(u => {
                console.log('Checking user:', u.email, u.password, u.status);
                return u.email === email && u.password === password && u.status === 'Aktif';
            });
            
            console.log('Found user:', user);
            
            if (user) {
                isLoggedIn = true;
                isPublicView = false;
                currentUser = { ...user };
                delete currentUser.password;
                
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                console.log('Login successful');
                return true;
            }
            console.log('Login failed');
            return false;
        }

        function logout() {
            const confirmLogout = document.createElement('div');
            confirmLogout.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            confirmLogout.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
                    <h3 class="text-lg font-semibold mb-4">Konfirmasi Logout</h3>
                    <p class="text-gray-600 mb-6">Apakah Anda yakin ingin keluar dari sistem?</p>
                    <div class="flex justify-end space-x-3">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                            Batal
                        </button>
                        <button onclick="confirmLogoutAction()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            Ya, Keluar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmLogout);
        }

        function confirmLogoutAction() {
            isLoggedIn = false;
            isPublicView = true;
            currentUser = null;
            
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('currentUser');
            
            document.querySelector('.fixed.inset-0.bg-black').remove();
            showLoginModal();
            updateUIForAuthState();
        }

        function showLoginModal() {
            document.getElementById('modal-login').classList.remove('hidden');
            document.getElementById('public-view-notice').classList.add('hidden');
            
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('form-login').reset();
        }

        function hideLoginModal() {
            document.getElementById('modal-login').classList.add('hidden');
        }

        function showPublicView() {
            isPublicView = true;
            hideLoginModal();
            document.getElementById('public-view-notice').classList.remove('hidden');
            updateUIForAuthState();
        }

        function updateUIForAuthState() {
            const sidebar = document.getElementById('sidebar');
            const syncButton = document.getElementById('sync-button');
            const logoutButton = document.getElementById('logout-button');
            const userWelcome = document.getElementById('user-welcome');
            const addSuratMasukBtn = document.getElementById('add-surat-masuk-btn');
            const addSuratKeluarBtn = document.getElementById('add-surat-keluar-btn');
            const publicNotice = document.getElementById('public-view-notice');
            const mainContent = document.querySelector('.lg\\:ml-64');
            
            if (isLoggedIn && currentUser) {
                sidebar.style.display = 'block';
                syncButton.style.display = 'flex';
                logoutButton.style.display = 'block';
                userWelcome.textContent = `Selamat datang, ${currentUser.nama}`;
                
                if (addSuratMasukBtn) addSuratMasukBtn.style.display = 'block';
                if (addSuratKeluarBtn) addSuratKeluarBtn.style.display = 'block';
                
                updateAdminFeatures();
                publicNotice.classList.add('hidden');
                mainContent.classList.remove('pt-16');
                
            } else {
                sidebar.style.display = 'block';
                syncButton.style.display = 'flex';
                logoutButton.style.display = 'none';
                userWelcome.textContent = 'Mode Publik - Hanya Baca';
                
                if (addSuratMasukBtn) addSuratMasukBtn.style.display = 'none';
                if (addSuratKeluarBtn) addSuratKeluarBtn.style.display = 'none';
                
                hideAdminFeatures();
                publicNotice.classList.remove('hidden');
                mainContent.classList.add('pt-16');
            }
            
            updateTableActionButtons();
        }

        function updateAdminFeatures() {
            const managementPages = ['surat-masuk', 'surat-keluar', 'pengguna'];
            managementPages.forEach(page => {
                const button = document.querySelector(`button[onclick="showPage('${page}')"]`);
                if (button) {
                    button.style.display = 'flex';
                }
            });
        }

        function hideAdminFeatures() {
            const managementPages = ['surat-masuk', 'surat-keluar', 'pengguna'];
            managementPages.forEach(page => {
                const button = document.querySelector(`button[onclick="showPage('${page}')"]`);
                if (button) {
                    if (page === 'pengguna') {
                        button.style.display = 'none';
                    } else {
                        button.style.display = 'flex';
                    }
                }
            });
        }

        function updateTableActionButtons() {
            const actionButtons = document.querySelectorAll('button[onclick*="disposisi"], button[onclick*="delete"], button[onclick*="edit"]');
            
            actionButtons.forEach(button => {
                if (isLoggedIn && !isPublicView) {
                    button.style.display = 'inline-block';
                } else {
                    button.style.display = 'none';
                }
            });
        }

        function requireAuth(callback) {
            if (!isLoggedIn || isPublicView) {
                showNotification('üîê Fitur ini hanya tersedia untuk pengguna yang sudah login!', 'warning');
                showLoginModal();
                return false;
            }
            
            if (typeof callback === 'function') {
                callback();
            }
            return true;
        }

        // Utility functions
        function getKlasifikasiColor(klasifikasi) {
            const colors = {
                'Keputusan': 'bg-red-100 text-red-800',
                'Perintah': 'bg-orange-100 text-orange-800',
                'Nota Dinas': 'bg-blue-100 text-blue-800',
                'Tugas': 'bg-green-100 text-green-800',
                'Permohonan': 'bg-purple-100 text-purple-800',
                'Undangan': 'bg-pink-100 text-pink-800',
                'Lainnya': 'bg-gray-100 text-gray-800'
            };
            return colors[klasifikasi] || 'bg-gray-100 text-gray-800';
        }

        function getTingkatColor(tingkat) {
            const colors = {
                'Biasa': 'bg-blue-100 text-blue-800',
                'Penting': 'bg-yellow-100 text-yellow-800',
                'Rahasia': 'bg-red-100 text-red-800',
                'Segera': 'bg-orange-100 text-orange-800'
            };
            return colors[tingkat] || 'bg-gray-100 text-gray-800';
        }

        function getStatusColor(status) {
            const colors = {
                'Menunggu Disposisi': 'bg-yellow-100 text-yellow-800',
                'Diproses': 'bg-blue-100 text-blue-800',
                'Selesai': 'bg-green-100 text-green-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        function getPriorityColor(priority) {
            const colors = {
                'Rendah': 'bg-green-100 text-green-800',
                'Sedang': 'bg-yellow-100 text-yellow-800',
                'Tinggi': 'bg-orange-100 text-orange-800',
                'Sangat Tinggi': 'bg-red-100 text-red-800'
            };
            return colors[priority] || 'bg-gray-100 text-gray-800';
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMins < 60) {
                return `${diffMins} menit lalu`;
            } else if (diffHours < 24) {
                return `${diffHours} jam lalu`;
            } else {
                return `${diffDays} hari lalu`;
            }
        }

        // Dashboard functions
        function updateDashboardStats() {
            const today = new Date().toDateString();
            
            const suratMasukHariIni = suratMasukData.filter(surat => {
                const suratDate = new Date(surat['Tanggal Diterima']).toDateString();
                return suratDate === today;
            }).length;
            
            const suratKeluarHariIni = suratKeluarData.filter(surat => {
                const suratDate = new Date(surat['Tanggal Surat']).toDateString();
                return suratDate === today;
            }).length;
            
            const menungguDisposisi = suratMasukData.filter(surat => 
                surat.Status === 'Menunggu Disposisi'
            ).length;
            
            const totalArsip = suratMasukData.length + suratKeluarData.length;
            
            document.getElementById('stat-surat-masuk-hari-ini').textContent = suratMasukHariIni;
            document.getElementById('stat-surat-keluar-hari-ini').textContent = suratKeluarHariIni;
            document.getElementById('stat-menunggu-disposisi').textContent = menungguDisposisi;
            document.getElementById('stat-total-arsip').textContent = totalArsip.toLocaleString('id-ID');
        }

        function updateRecentActivity() {
            const container = document.getElementById('recent-activity-container');
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            let activities = [];
            
            suratMasukData.forEach(surat => {
                const suratDate = new Date(surat['Tanggal Diterima']);
                if (suratDate >= yesterday) {
                    activities.push({
                        type: 'masuk',
                        icon: 'üì•',
                        bgColor: 'bg-blue-50',
                        textColor: 'text-blue-600',
                        title: `Surat masuk dari ${surat.Pengirim}`,
                        subtitle: `No. ${surat['No. Surat']} - ${surat.Perihal}`,
                        date: suratDate,
                        timestamp: surat.Timestamp || suratDate.toISOString()
                    });
                }
            });
            
            suratKeluarData.forEach(surat => {
                const suratDate = new Date(surat['Tanggal Surat']);
                if (suratDate >= yesterday) {
                    activities.push({
                        type: 'keluar',
                        icon: 'üì§',
                        bgColor: 'bg-green-50',
                        textColor: 'text-green-600',
                        title: `Surat keluar ke ${surat.Penerima}`,
                        subtitle: `No. ${surat['No. Surat']} - ${surat.Perihal}`,
                        date: suratDate,
                        timestamp: surat.Timestamp || suratDate.toISOString()
                    });
                }
            });
            
            activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            activities = activities.slice(0, 5);
            
            if (activities.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-4">üìã</div>
                        <p>Belum ada aktivitas hari ini</p>
                        <p class="text-sm mt-2">Aktivitas akan muncul setelah ada surat masuk/keluar</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            activities.forEach(activity => {
                const timeAgo = getTimeAgo(new Date(activity.timestamp));
                html += `
                    <div class="flex items-center space-x-3 p-3 ${activity.bgColor} rounded-lg">
                        <div class="text-2xl">${activity.icon}</div>
                        <div class="flex-1">
                            <p class="font-medium ${activity.textColor}">${activity.title}</p>
                            <p class="text-sm text-gray-600">${activity.subtitle}</p>
                            <p class="text-xs text-gray-500 mt-1">${timeAgo}</p>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Load surat masuk table
        function loadSuratMasukTable() {
            const tbody = document.getElementById('surat-masuk-table-body');
            if (!tbody) return;
            
            if (suratMasukData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                            <div class="text-4xl mb-4">üì•</div>
                            <p>Belum ada data surat masuk</p>
                            <p class="text-sm mt-2">Klik "Tambah Surat Masuk" untuk menambah data</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            suratMasukData.forEach((surat, index) => {
                const fileLink = surat['File URL'] ? `
                    <a href="${surat['File URL']}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 text-xs">
                        üìé File
                    </a>
                ` : '<span class="text-gray-400 text-xs">-</span>';
                
                const actionButtons = isLoggedIn && !isPublicView ? `
                    <button onclick="buatDisposisi('${surat['No. Surat']}')" class="text-blue-600 hover:text-blue-800 text-sm mr-2">
                        üìã Disposisi
                    </button>
                    <button onclick="deleteSuratMasuk(${index})" class="text-red-600 hover:text-red-800 text-sm">
                        üóëÔ∏è Hapus
                    </button>
                ` : `
                    <span class="text-gray-400 text-sm">Hanya Baca</span>
                `;
                
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm">${surat['No. Surat'] || '-'}</td>
                        <td class="px-6 py-4 text-sm">${formatDate(surat['Tanggal Surat'])}</td>
                        <td class="px-6 py-4 text-sm">${surat.Pengirim || '-'}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded-full ${getKlasifikasiColor(surat.Klasifikasi)}">
                                ${surat.Klasifikasi || '-'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm max-w-xs truncate">${surat.Perihal || '-'}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(surat.Status)}">
                                ${surat.Status || 'Menunggu Disposisi'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center">${fileLink}</td>
                        <td class="px-6 py-4 text-sm">${actionButtons}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // Load surat keluar table
        function loadSuratKeluarTable() {
            const tbody = document.getElementById('surat-keluar-table-body');
            if (!tbody) return;
            
            if (suratKeluarData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                            <div class="text-4xl mb-4">üì§</div>
                            <p>Belum ada data surat keluar</p>
                            <p class="text-sm mt-2">Klik "Tambah Surat Keluar" untuk menambah data</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            suratKeluarData.forEach((surat, index) => {
                const fileLink = surat['File URL'] ? `
                    <a href="${surat['File URL']}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 text-xs">
                        üìé File
                    </a>
                ` : '<span class="text-gray-400 text-xs">-</span>';
                
                const actionButtons = isLoggedIn && !isPublicView ? `
                    <button onclick="deleteSuratKeluar(${index})" class="text-red-600 hover:text-red-800 text-sm">
                        üóëÔ∏è Hapus
                    </button>
                ` : `
                    <span class="text-gray-400 text-sm">Hanya Baca</span>
                `;
                
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm">${surat['No. Surat'] || '-'}</td>
                        <td class="px-6 py-4 text-sm">${formatDate(surat['Tanggal Surat'])}</td>
                        <td class="px-6 py-4 text-sm">${surat.Penerima || '-'}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded-full ${getKlasifikasiColor(surat.Klasifikasi)}">
                                ${surat.Klasifikasi || '-'}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded-full ${getTingkatColor(surat['Tingkat Kepentingan'])}">
                                ${surat['Tingkat Kepentingan'] || '-'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm max-w-xs truncate">${surat.Perihal || '-'}</td>
                        <td class="px-6 py-4 text-center">${fileLink}</td>
                        <td class="px-6 py-4 text-sm">${actionButtons}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // Load disposisi table
        function loadDisposisiTable() {
            const tbody = document.getElementById('disposisi-table-body');
            if (!tbody) return;
            
            if (disposisiData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                            <div class="text-4xl mb-4">üìã</div>
                            <p>Belum ada data disposisi</p>
                            <p class="text-sm mt-2">Disposisi akan muncul setelah surat masuk didisposisi</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            disposisiData.forEach((disposisi, index) => {
                const surat = suratMasukData.find(s => s['No. Surat'] === disposisi.nomorSurat);
                
                const actionButtons = isLoggedIn && !isPublicView ? `
                    <button onclick="showDetailDisposisi('${disposisi.nomorSurat}')" class="text-blue-600 hover:text-blue-800 text-sm mr-2">
                        üëÅÔ∏è Detail
                    </button>
                    <button onclick="deleteDisposisi(${index})" class="text-red-600 hover:text-red-800 text-sm">
                        üóëÔ∏è Hapus
                    </button>
                ` : `
                    <button onclick="showDetailDisposisi('${disposisi.nomorSurat}')" class="text-blue-600 hover:text-blue-800 text-sm">
                        üëÅÔ∏è Detail
                    </button>
                `;
                
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-medium">${disposisi.nomorSurat}</td>
                        <td class="px-4 py-3 text-sm">${surat ? surat.Pengirim : '-'}</td>
                        <td class="px-4 py-3 text-sm max-w-xs truncate">${surat ? surat.Perihal : '-'}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(surat ? surat.Status : 'Diproses')}">
                                ${surat ? surat.Status : 'Diproses'}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm">${disposisi.disposisiKepada}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs rounded-full ${getPriorityColor(disposisi.prioritas)}">
                                ${disposisi.prioritas}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm">${formatDate(disposisi.tanggalDisposisi)}</td>
                        <td class="px-4 py-3 text-sm">${actionButtons}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // Load users table
        function loadUsersTable() {
            const tbody = document.getElementById('users-table-body');
            if (!tbody) return;
            
            let html = '';
            userData.forEach((user, index) => {
                const actionButtons = isLoggedIn && !isPublicView ? `
                    <button onclick="deleteUser(${index})" class="text-red-600 hover:text-red-800 text-sm">
                        üóëÔ∏è Hapus
                    </button>
                ` : `
                    <span class="text-gray-400 text-sm">Hanya Baca</span>
                `;
                
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm">${user.nama}</td>
                        <td class="px-6 py-4 text-sm">${user.email}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">
                                ${user.role}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded-full ${user.status === 'Aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${user.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm">${actionButtons}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // Form handlers
        function setupFormHandlers() {
            // Setup file upload handlers
            setupFileUploadHandlers();
            
            // Surat Masuk Form
            const formSuratMasuk = document.getElementById('form-surat-masuk');
            if (formSuratMasuk) {
                formSuratMasuk.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    if (!requireAuth()) return;
                    
                    const submitButton = this.querySelector('button[type="submit"]');
                    const submitText = submitButton.querySelector('.submit-text');
                    const loadingText = submitButton.querySelector('.loading-text');
                    
                    // Show loading
                    submitText.classList.add('hidden');
                    loadingText.classList.remove('hidden');
                    submitButton.disabled = true;
                    
                    try {
                        const formData = new FormData(this);
                        const data = Object.fromEntries(formData.entries());
                        
                        // Handle file upload if file is selected
                        let fileUrl = '';
                        const fileInput = document.getElementById('lampiran-masuk');
                        if (fileInput.files.length > 0) {
                            const file = fileInput.files[0];
                            const fileName = `SM_${data.nomorSurat.replace(/[^a-zA-Z0-9]/g, '_')}_${file.name}`;
                            
                            loadingText.textContent = 'Mengupload file...';
                            const uploadResult = await FileUploadHelper.uploadToGoogleDrive(file, fileName);
                            
                            if (uploadResult.success) {
                                fileUrl = uploadResult.fileUrl;
                                showNotification('üìÅ File berhasil diupload ke Google Drive!', 'success');
                            } else {
                                showNotification(`‚ùå ${uploadResult.message}`, 'error');
                                // Continue without file if upload fails
                            }
                        }
                        
                        loadingText.textContent = 'Menyimpan data...';
                        
                        // Convert form field names to match table headers
                        const suratData = {
                            'No. Surat': data.nomorSurat,
                            'Tanggal Surat': data.tanggalSurat,
                            'Tanggal Diterima': data.tanggalDiterima,
                            'Pengirim': data.pengirim,
                            'Klasifikasi': data.klasifikasi,
                            'Tingkat Kepentingan': data.tingkatKepentingan,
                            'Perihal': data.perihal,
                            'Status': 'Menunggu Disposisi',
                            'File URL': fileUrl,
                            'timestamp': new Date().toISOString()
                        };
                        
                        // Try to save to Firebase first
                        if (window.db && window.auth.currentUser) {
                            await FirebaseHelper.addDocument('surat-masuk', suratData);
                            showNotification('‚úÖ Surat masuk berhasil disimpan ke Firebase!', 'success');
                        } else {
                            // Fallback to localStorage
                            suratData.id = Date.now();
                            suratMasukData.push(suratData);
                            localStorage.setItem('suratMasukData', JSON.stringify(suratMasukData));
                            showNotification('‚úÖ Surat masuk berhasil disimpan secara lokal!', 'success');
                        }
                        
                        hideModal('modal-surat-masuk');
                        
                    } catch (error) {
                        console.error('Error saving surat masuk:', error);
                        showNotification('‚ùå Gagal menyimpan surat masuk!', 'error');
                    } finally {
                        // Hide loading
                        submitText.classList.remove('hidden');
                        loadingText.classList.add('hidden');
                        loadingText.textContent = 'Menyimpan...';
                        submitButton.disabled = false;
                    }
                });
            }
            
            // Surat Keluar Form
            const formSuratKeluar = document.getElementById('form-surat-keluar');
            if (formSuratKeluar) {
                formSuratKeluar.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    if (!requireAuth()) return;
                    
                    const submitButton = this.querySelector('button[type="submit"]');
                    const submitText = submitButton.querySelector('.submit-text');
                    const loadingText = submitButton.querySelector('.loading-text');
                    
                    // Show loading
                    submitText.classList.add('hidden');
                    loadingText.classList.remove('hidden');
                    submitButton.disabled = true;
                    
                    try {
                        const formData = new FormData(this);
                        const data = Object.fromEntries(formData.entries());
                        
                        // Handle file upload if file is selected
                        let fileUrl = '';
                        const fileInput = document.getElementById('lampiran-keluar');
                        if (fileInput.files.length > 0) {
                            const file = fileInput.files[0];
                            const fileName = `SK_${data.nomorSurat.replace(/[^a-zA-Z0-9]/g, '_')}_${file.name}`;
                            
                            loadingText.textContent = 'Mengupload file...';
                            const uploadResult = await FileUploadHelper.uploadToGoogleDrive(file, fileName);
                            
                            if (uploadResult.success) {
                                fileUrl = uploadResult.fileUrl;
                                showNotification('üìÅ File berhasil diupload ke Google Drive!', 'success');
                            } else {
                                showNotification(`‚ùå ${uploadResult.message}`, 'error');
                                // Continue without file if upload fails
                            }
                        }
                        
                        loadingText.textContent = 'Menyimpan data...';
                        
                        // Convert form field names to match table headers
                        const suratData = {
                            'No. Surat': data.nomorSurat,
                            'Tanggal Surat': data.tanggalSurat,
                            'Penerima': data.penerima,
                            'Klasifikasi': data.klasifikasi,
                            'Tingkat Kepentingan': data.tingkatKepentingan,
                            'Perihal': data.perihal,
                            'File URL': fileUrl,
                            'timestamp': new Date().toISOString()
                        };
                        
                        // Try to save to Firebase first
                        if (window.db && window.auth.currentUser) {
                            await FirebaseHelper.addDocument('surat-keluar', suratData);
                            showNotification('‚úÖ Surat keluar berhasil disimpan ke Firebase!', 'success');
                        } else {
                            // Fallback to localStorage
                            suratData.id = Date.now();
                            suratKeluarData.push(suratData);
                            localStorage.setItem('suratKeluarData', JSON.stringify(suratKeluarData));
                            showNotification('‚úÖ Surat keluar berhasil disimpan secara lokal!', 'success');
                        }
                        
                        hideModal('modal-surat-keluar');
                        
                    } catch (error) {
                        console.error('Error saving surat keluar:', error);
                        showNotification('‚ùå Gagal menyimpan surat keluar!', 'error');
                    } finally {
                        // Hide loading
                        submitText.classList.remove('hidden');
                        loadingText.classList.add('hidden');
                        loadingText.textContent = 'Menyimpan...';
                        submitButton.disabled = false;
                    }
                });
            }
            
            // User Form
            const formUser = document.getElementById('form-user');
            if (formUser) {
                formUser.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    if (!requireAuth()) return;
                    
                    const formData = new FormData(this);
                    const data = Object.fromEntries(formData.entries());
                    
                    // Check if email already exists
                    if (userData.some(user => user.email === data.email)) {
                        showNotification('‚ùå Email sudah terdaftar!', 'error');
                        return;
                    }
                    
                    // Add new user
                    const newUser = {
                        id: Date.now(),
                        nama: data.nama,
                        email: data.email,
                        password: data.password,
                        role: data.role,
                        status: 'Aktif',
                        tanggalDibuat: new Date().toISOString()
                    };
                    
                    userData.push(newUser);
                    localStorage.setItem('userData', JSON.stringify(userData));
                    
                    hideModal('modal-user');
                    loadUsersTable();
                    showNotification('‚úÖ Pengguna berhasil ditambahkan!', 'success');
                });
            }
            
            // Disposisi Form
            const formDisposisi = document.getElementById('form-disposisi');
            if (formDisposisi) {
                formDisposisi.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    if (!requireAuth()) return;
                    
                    const submitButton = this.querySelector('button[type="submit"]');
                    const submitText = submitButton.querySelector('.submit-text');
                    const loadingText = submitButton.querySelector('.loading-text');
                    
                    // Show loading
                    submitText.classList.add('hidden');
                    loadingText.classList.remove('hidden');
                    submitButton.disabled = true;
                    
                    try {
                        const formData = new FormData(this);
                        const data = Object.fromEntries(formData.entries());
                        
                        // Get selected instructions
                        const instruksiCheckboxes = formDisposisi.querySelectorAll('input[name="instruksi"]:checked');
                        const instruksiArray = Array.from(instruksiCheckboxes).map(cb => cb.value);
                        
                        // Get disposisi kepada value
                        let disposisiKepada = data.disposisiKepada;
                        if (disposisiKepada === 'Lainnya') {
                            disposisiKepada = document.getElementById('manual-disposisi-kepada').value;
                        }
                        
                        const newDisposisi = {
                            nomorSurat: currentDisposisiSurat,
                            tanggalDisposisi: data.tanggalDisposisi,
                            disposisiKepada: disposisiKepada,
                            prioritas: data.prioritas,
                            instruksi: instruksiArray.join(', '),
                            catatanDisposisi: data.catatanDisposisi,
                            batasWaktu: data.batasWaktu,
                            statusTindakLanjut: data.statusTindakLanjut,
                            sifatDisposisi: data.sifatDisposisi,
                            timestamp: new Date().toISOString()
                        };
                        
                        // Try to save to Firebase first
                        if (window.db && window.auth.currentUser) {
                            await FirebaseHelper.addDocument('disposisi', newDisposisi);
                            
                            // Update surat status in Firebase
                            const suratToUpdate = suratMasukData.find(s => s['No. Surat'] === currentDisposisiSurat);
                            if (suratToUpdate && suratToUpdate.id) {
                                await FirebaseHelper.updateDocument('surat-masuk', suratToUpdate.id, {
                                    'Status': 'Diproses'
                                });
                            }
                            
                            showNotification('‚úÖ Disposisi berhasil disimpan ke Firebase!', 'success');
                        } else {
                            // Fallback to localStorage
                            newDisposisi.id = Date.now();
                            disposisiData.push(newDisposisi);
                            localStorage.setItem('disposisiData', JSON.stringify(disposisiData));
                            
                            // Update surat status locally
                            const suratIndex = suratMasukData.findIndex(s => s['No. Surat'] === currentDisposisiSurat);
                            if (suratIndex !== -1) {
                                suratMasukData[suratIndex].Status = 'Diproses';
                                localStorage.setItem('suratMasukData', JSON.stringify(suratMasukData));
                            }
                            
                            showNotification('‚úÖ Disposisi berhasil disimpan secara lokal!', 'success');
                        }
                        
                        hideModal('modal-disposisi');
                        
                    } catch (error) {
                        console.error('Error saving disposisi:', error);
                        showNotification('‚ùå Gagal menyimpan disposisi!', 'error');
                    } finally {
                        // Hide loading
                        submitText.classList.remove('hidden');
                        loadingText.classList.add('hidden');
                        submitButton.disabled = false;
                    }
                });
            }
            
            // Login Form
            const formLogin = document.getElementById('form-login');
            if (formLogin) {
                formLogin.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const email = document.getElementById('email-login').value;
                    const password = document.getElementById('password-login').value;
                    const loginButton = this.querySelector('button[type="submit"]');
                    const loginText = loginButton.querySelector('.login-text');
                    const loginLoading = loginButton.querySelector('.login-loading');
                    const errorDiv = document.getElementById('login-error');
                    
                    // Show loading
                    loginText.classList.add('hidden');
                    loginLoading.classList.remove('hidden');
                    loginButton.disabled = true;
                    errorDiv.classList.add('hidden');
                    
                    // Simulate login process
                    setTimeout(() => {
                        if (login(email, password)) {
                            hideLoginModal();
                            updateUIForAuthState();
                            showNotification('‚úÖ Login berhasil! Selamat datang di sistem.', 'success');
                            showPage('dashboard');
                        } else {
                            errorDiv.classList.remove('hidden');
                            showNotification('‚ùå Email atau password salah!', 'error');
                        }
                        
                        // Hide loading
                        loginText.classList.remove('hidden');
                        loginLoading.classList.add('hidden');
                        loginButton.disabled = false;
                    }, 1000);
                });
            }
        }

        // Additional functions
        function buatDisposisi(nomorSurat) {
            if (!requireAuth()) return;
            
            currentDisposisiSurat = nomorSurat;
            const surat = suratMasukData.find(s => s['No. Surat'] === nomorSurat);
            
            if (surat) {
                // Fill surat information in modal
                document.getElementById('disposisi-nomor-surat').textContent = surat['No. Surat'];
                document.getElementById('disposisi-tanggal').textContent = formatDate(surat['Tanggal Surat']);
                document.getElementById('disposisi-pengirim').textContent = surat.Pengirim;
                document.getElementById('disposisi-perihal').textContent = surat.Perihal;
                
                // Set default date
                document.getElementById('tanggal-disposisi').value = new Date().toISOString().split('T')[0];
                
                showModal('modal-disposisi');
            }
        }

        function toggleManualInput() {
            const select = document.getElementById('disposisi-kepada-select');
            const manualDiv = document.getElementById('manual-disposisi-input');
            
            if (select.value === 'Lainnya') {
                manualDiv.classList.remove('hidden');
                document.getElementById('manual-disposisi-kepada').required = true;
            } else {
                manualDiv.classList.add('hidden');
                document.getElementById('manual-disposisi-kepada').required = false;
            }
        }

        function refreshAllDisplays() {
            updateDashboardStats();
            updateRecentActivity();
            loadSuratMasukTable();
            loadSuratKeluarTable();
            loadDisposisiTable();
            loadUsersTable();
            initializeCharts();
        }

        // Setup file upload handlers
        function setupFileUploadHandlers() {
            // File input change handlers
            const lampiranMasuk = document.getElementById('lampiran-masuk');
            const lampiranKeluar = document.getElementById('lampiran-keluar');
            
            if (lampiranMasuk) {
                lampiranMasuk.addEventListener('change', function(e) {
                    handleFileSelection(e, 'masuk');
                });
            }
            
            if (lampiranKeluar) {
                lampiranKeluar.addEventListener('change', function(e) {
                    handleFileSelection(e, 'keluar');
                });
            }
        }
        
        // Handle file selection
        function handleFileSelection(event, type) {
            const file = event.target.files[0];
            const container = event.target.closest('div');
            
            // Remove previous status messages
            const existingStatus = container.querySelectorAll('#upload-progress, #upload-success, #upload-error, #file-selected');
            existingStatus.forEach(el => el.remove());
            
            if (!file) return;
            
            // Validate file
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
            
            if (file.size > maxSize) {
                container.insertAdjacentHTML('beforeend', FileUploadHelper.showUploadError('File terlalu besar. Maksimal 10MB'));
                event.target.value = '';
                return;
            }
            
            if (!allowedTypes.includes(file.type)) {
                container.insertAdjacentHTML('beforeend', FileUploadHelper.showUploadError('Format file tidak didukung. Gunakan PDF, JPG, JPEG, atau PNG'));
                event.target.value = '';
                return;
            }
            
            // Show file selected message
            const selectedHtml = `
                <div id="file-selected" class="mt-3 p-3 bg-gray-50 border border-gray-200 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <div class="text-gray-600">üìé</div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-800">File dipilih:</p>
                            <p class="text-xs text-gray-600">${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</p>
                            <p class="text-xs text-blue-600 mt-1">‚úì File akan diupload ke Google Drive saat form disimpan</p>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', selectedHtml);
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', async function() {
            // Ensure user data is saved to localStorage
            localStorage.setItem('userData', JSON.stringify(userData));
            console.log('User data initialized:', userData);
            
            // Initialize Firebase
            const firebaseInitialized = await FirebaseHelper.initializeFirebase();
            
            if (firebaseInitialized) {
                // Try to load data from Firebase
                const dataLoaded = await FirebaseHelper.loadAllData();
                if (dataLoaded) {
                    console.log('Data loaded from Firebase successfully');
                    refreshAllDisplays();
                }
            }
            
            // Check authentication state
            const savedLoginState = localStorage.getItem('isLoggedIn');
            const savedUser = localStorage.getItem('currentUser');
            
            if (savedLoginState === 'true' && savedUser) {
                isLoggedIn = true;
                isPublicView = false;
                currentUser = JSON.parse(savedUser);
                updateUIForAuthState();
                showPage('dashboard');
            } else {
                showLoginModal();
            }
            
            // Setup form handlers
            setupFormHandlers();
            
            // Update last sync info
            updateLastSyncInfo();
            setInterval(updateLastSyncInfo, 60000); // Update every minute
            
            // Mobile menu toggle
            document.getElementById('mobile-menu-btn').addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('-translate-x-full');
            });
        });

        // Initialize charts
        function initializeCharts() {
            const ctx = document.getElementById('monthlyChart');
            if (!ctx) return;
            
            if (monthlyChart) {
                monthlyChart.destroy();
            }
            
            const months = [];
            const suratMasukCounts = [];
            const suratKeluarCounts = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthYear = date.toLocaleDateString('id-ID', { month: 'short', year: 'numeric' });
                months.push(monthYear);
                
                const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
                const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);
                
                const masukCount = suratMasukData.filter(surat => {
                    const suratDate = new Date(surat['Tanggal Diterima']);
                    return suratDate >= monthStart && suratDate <= monthEnd;
                }).length;
                
                const keluarCount = suratKeluarData.filter(surat => {
                    const suratDate = new Date(surat['Tanggal Surat']);
                    return suratDate >= monthStart && suratDate <= monthEnd;
                }).length;
                
                suratMasukCounts.push(masukCount);
                suratKeluarCounts.push(keluarCount);
            }
            
            monthlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Surat Masuk',
                        data: suratMasukCounts,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Surat Keluar',
                        data: suratKeluarCounts,
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Page navigation
        function showPage(pageId) {
            // Hide all pages
            const pages = ['dashboard', 'surat-masuk', 'surat-keluar', 'disposisi', 'arsip', 'laporan', 'pengguna'];
            pages.forEach(page => {
                const element = document.getElementById(`${page}-page`);
                if (element) {
                    element.classList.add('hidden');
                }
            });
            
            // Show selected page
            const selectedPage = document.getElementById(`${pageId}-page`);
            if (selectedPage) {
                selectedPage.classList.remove('hidden');
            }
            
            // Update page title
            const titles = {
                'dashboard': 'Dashboard',
                'surat-masuk': 'Surat Masuk',
                'surat-keluar': 'Surat Keluar',
                'disposisi': 'Disposisi',
                'arsip': 'Pencarian & Arsip',
                'laporan': 'Laporan',
                'pengguna': 'Manajemen Pengguna'
            };
            
            document.getElementById('page-title').textContent = titles[pageId] || 'Dashboard';
            
            // Update sidebar active state
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('bg-gradient-to-r', 'from-purple-500', 'to-blue-500', 'text-white');
            });
            
            const activeButton = document.querySelector(`button[onclick="showPage('${pageId}')"]`);
            if (activeButton) {
                activeButton.classList.add('bg-gradient-to-r', 'from-purple-500', 'to-blue-500', 'text-white');
            }
            
            // Load page-specific data
            switch(pageId) {
                case 'dashboard':
                    updateDashboardStats();
                    updateRecentActivity();
                    initializeCharts();
                    break;
                case 'surat-masuk':
                    loadSuratMasukTable();
                    break;
                case 'surat-keluar':
                    loadSuratKeluarTable();
                    break;
                case 'disposisi':
                    loadDisposisiTable();
                    updateDisposisiStats();
                    break;
                case 'arsip':
                    // Arsip page doesn't need initial data loading
                    break;
                case 'laporan':
                    updateReportStats();
                    initializeReportCharts();
                    break;
                case 'pengguna':
                    loadUsersTable();
                    break;
            }
        }

        // Modal functions
        function showModal(modalId) {
            if (!isLoggedIn || isPublicView) {
                requireAuth();
                return;
            }
            
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                
                // Set default date for forms
                const dateInputs = modal.querySelectorAll('input[type="date"]');
                dateInputs.forEach(input => {
                    if (!input.value) {
                        input.value = new Date().toISOString().split('T')[0];
                    }
                });
            }
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
                
                // Reset form
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                    
                    // Hide loading states
                    const submitTexts = form.querySelectorAll('.submit-text');
                    const loadingTexts = form.querySelectorAll('.loading-text');
                    
                    submitTexts.forEach(text => text.classList.remove('hidden'));
                    loadingTexts.forEach(text => text.classList.add('hidden'));
                }
            }
        }

        // Table loading functions
        function loadSuratMasukTable() {
            const tbody = document.getElementById('surat-masuk-table-body');
            if (!tbody) return;
            
            if (suratMasukData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                            <div class="text-4xl mb-4">üì•</div>
                            <p>Belum ada data surat masuk</p>
                            <p class="text-sm mt-2">Klik "Tambah Surat Masuk" untuk menambah data</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            suratMasukData.forEach((surat, index) => {
                const actionButtons = isLoggedIn && !isPublicView ? `
                    <button onclick="buatDisposisi('${surat['No. Surat']}')" class="text-blue-600 hover:text-blue-800 text-sm mr-2">
                        üìã Disposisi
                    </button>
                    <button onclick="deleteSuratMasuk(${index})" class="text-red-600 hover:text-red-800 text-sm">
                        üóëÔ∏è Hapus
                    </button>
                ` : `
                    <span class="text-gray-400 text-sm">Hanya Baca</span>
                `;
                
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm">${surat['No. Surat'] || '-'}</td>
                        <td class="px-6 py-4 text-sm">${formatDate(surat['Tanggal Surat'])}</td>
                        <td class="px-6 py-4 text-sm">${surat.Pengirim || '-'}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded-full ${getKlasifikasiColor(surat.Klasifikasi)}">
                                ${surat.Klasifikasi || '-'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm max-w-xs truncate">${surat.Perihal || '-'}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(surat.Status)}">
                                ${surat.Status || 'Menunggu Disposisi'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm">${actionButtons}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // Delete functions
        function deleteSuratMasuk(index) {
            if (!requireAuth()) return;
            
            const confirmDelete = document.createElement('div');
            confirmDelete.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            confirmDelete.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
                    <h3 class="text-lg font-semibold mb-4">Konfirmasi Hapus</h3>
                    <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus surat ini?</p>
                    <div class="flex justify-end space-x-3">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                            Batal
                        </button>
                        <button onclick="confirmDeleteSuratMasuk(${index})" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            Ya, Hapus
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmDelete);
        }

        async function confirmDeleteSuratMasuk(index) {
            try {
                const surat = suratMasukData[index];
                
                // Try to delete from Firebase first
                if (window.db && window.auth.currentUser && surat.id) {
                    await FirebaseHelper.deleteDocument('surat-masuk', surat.id);
                    showNotification('‚úÖ Surat masuk berhasil dihapus dari Firebase!', 'success');
                } else {
                    // Fallback to localStorage
                    suratMasukData.splice(index, 1);
                    localStorage.setItem('suratMasukData', JSON.stringify(suratMasukData));
                    loadSuratMasukTable();
                    updateDashboardStats();
                    showNotification('‚úÖ Surat masuk berhasil dihapus secara lokal!', 'success');
                }
                
            } catch (error) {
                console.error('Error deleting surat masuk:', error);
                showNotification('‚ùå Gagal menghapus surat masuk!', 'error');
            }
            
            document.querySelector('.fixed.inset-0.bg-black').remove();
        }

        function deleteSuratKeluar(index) {
            if (!requireAuth()) return;
            
            const confirmDelete = document.createElement('div');
            confirmDelete.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            confirmDelete.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
                    <h3 class="text-lg font-semibold mb-4">Konfirmasi Hapus</h3>
                    <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus surat ini?</p>
                    <div class="flex justify-end space-x-3">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                            Batal
                        </button>
                        <button onclick="confirmDeleteSuratKeluar(${index})" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            Ya, Hapus
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmDelete);
        }

        function confirmDeleteSuratKeluar(index) {
            suratKeluarData.splice(index, 1);
            localStorage.setItem('suratKeluarData', JSON.stringify(suratKeluarData));
            
            document.querySelector('.fixed.inset-0.bg-black').remove();
            loadSuratKeluarTable();
            updateDashboardStats();
            showNotification('‚úÖ Surat keluar berhasil dihapus!', 'success');
        }

        function deleteDisposisi(index) {
            if (!requireAuth()) return;
            
            const confirmDelete = document.createElement('div');
            confirmDelete.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            confirmDelete.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
                    <h3 class="text-lg font-semibold mb-4">Konfirmasi Hapus</h3>
                    <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus disposisi ini?</p>
                    <div class="flex justify-end space-x-3">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                            Batal
                        </button>
                        <button onclick="confirmDeleteDisposisi(${index})" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            Ya, Hapus
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmDelete);
        }

        function confirmDeleteDisposisi(index) {
            const disposisi = disposisiData[index];
            
            // Update surat status back to "Menunggu Disposisi"
            const suratIndex = suratMasukData.findIndex(s => s['No. Surat'] === disposisi.nomorSurat);
            if (suratIndex !== -1) {
                suratMasukData[suratIndex].Status = 'Menunggu Disposisi';
                localStorage.setItem('suratMasukData', JSON.stringify(suratMasukData));
            }
            
            disposisiData.splice(index, 1);
            localStorage.setItem('disposisiData', JSON.stringify(disposisiData));
            
            document.querySelector('.fixed.inset-0.bg-black').remove();
            loadDisposisiTable();
            loadSuratMasukTable();
            updateDashboardStats();
            showNotification('‚úÖ Disposisi berhasil dihapus!', 'success');
        }

        function deleteUser(index) {
            if (!requireAuth()) return;
            
            const user = userData[index];
            if (user.email === currentUser.email) {
                showNotification('‚ùå Tidak dapat menghapus akun yang sedang digunakan!', 'error');
                return;
            }
            
            const confirmDelete = document.createElement('div');
            confirmDelete.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            confirmDelete.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
                    <h3 class="text-lg font-semibold mb-4">Konfirmasi Hapus</h3>
                    <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus pengguna "${user.nama}"?</p>
                    <div class="flex justify-end space-x-3">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                            Batal
                        </button>
                        <button onclick="confirmDeleteUser(${index})" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            Ya, Hapus
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmDelete);
        }

        function confirmDeleteUser(index) {
            userData.splice(index, 1);
            localStorage.setItem('userData', JSON.stringify(userData));
            
            document.querySelector('.fixed.inset-0.bg-black').remove();
            loadUsersTable();
            showNotification('‚úÖ Pengguna berhasil dihapus!', 'success');
        }

        // Disposisi functions
        function updateDisposisiStats() {
            const menungguDisposisi = suratMasukData.filter(surat => 
                surat.Status === 'Menunggu Disposisi'
            ).length;
            
            const sudahDisposisi = disposisiData.length;
            
            const prioritasTinggi = disposisiData.filter(disposisi => 
                disposisi.prioritas === 'Tinggi' || disposisi.prioritas === 'Sangat Tinggi'
            ).length;
            
            const today = new Date().toDateString();
            const disposisiHariIni = disposisiData.filter(disposisi => {
                const disposisiDate = new Date(disposisi.tanggalDisposisi).toDateString();
                return disposisiDate === today;
            }).length;
            
            document.getElementById('stat-menunggu-disposisi-page').textContent = menungguDisposisi;
            document.getElementById('stat-sudah-disposisi').textContent = sudahDisposisi;
            document.getElementById('stat-prioritas-tinggi').textContent = prioritasTinggi;
            document.getElementById('stat-disposisi-hari-ini').textContent = disposisiHariIni;
        }

        function filterDisposisi() {
            const statusFilter = document.getElementById('filter-status-disposisi').value;
            const prioritasFilter = document.getElementById('filter-prioritas').value;
            const penerimaFilter = document.getElementById('filter-penerima-disposisi').value;
            const searchFilter = document.getElementById('filter-search-disposisi').value.toLowerCase();
            
            const tbody = document.getElementById('disposisi-table-body');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 1) return; // Skip empty state row
                
                const nomorSurat = cells[0].textContent;
                const status = cells[3].textContent.trim();
                const penerima = cells[4].textContent;
                const prioritas = cells[5].textContent.trim();
                
                let show = true;
                
                if (statusFilter && !status.includes(statusFilter)) show = false;
                if (prioritasFilter && prioritas !== prioritasFilter) show = false;
                if (penerimaFilter && penerima !== penerimaFilter) show = false;
                if (searchFilter && !nomorSurat.toLowerCase().includes(searchFilter)) show = false;
                
                row.style.display = show ? '' : 'none';
            });
        }

        function refreshDisposisiData() {
            loadDisposisiTable();
            updateDisposisiStats();
            showNotification('üîÑ Data disposisi telah diperbarui!', 'info');
        }

        function showDetailDisposisi(nomorSurat) {
            const disposisi = disposisiData.find(d => d.nomorSurat === nomorSurat);
            const surat = suratMasukData.find(s => s['No. Surat'] === nomorSurat);
            
            if (!disposisi || !surat) {
                showNotification('‚ùå Data disposisi tidak ditemukan!', 'error');
                return;
            }
            
            // Fill surat information
            document.getElementById('detail-nomor-surat').textContent = surat['No. Surat'];
            document.getElementById('detail-tanggal-surat').textContent = formatDate(surat['Tanggal Surat']);
            document.getElementById('detail-tanggal-diterima').textContent = formatDate(surat['Tanggal Diterima']);
            document.getElementById('detail-pengirim').textContent = surat.Pengirim;
            document.getElementById('detail-klasifikasi').textContent = surat.Klasifikasi;
            document.getElementById('detail-tingkat').textContent = surat['Tingkat Kepentingan'];
            document.getElementById('detail-perihal').textContent = surat.Perihal;
            
            // Fill disposisi information
            document.getElementById('detail-tanggal-disposisi').textContent = formatDate(disposisi.tanggalDisposisi);
            document.getElementById('detail-disposisi-kepada').textContent = disposisi.disposisiKepada;
            document.getElementById('detail-prioritas').textContent = disposisi.prioritas;
            document.getElementById('detail-status-tindak-lanjut').textContent = disposisi.statusTindakLanjut;
            document.getElementById('detail-sifat-disposisi').textContent = disposisi.sifatDisposisi;
            document.getElementById('detail-batas-waktu').textContent = disposisi.batasWaktu ? formatDate(disposisi.batasWaktu) : 'Tidak ada';
            document.getElementById('detail-instruksi').textContent = disposisi.instruksi;
            document.getElementById('detail-catatan').textContent = disposisi.catatanDisposisi;
            
            showModal('modal-detail-disposisi');
        }

        function exportDisposisiToPDF() {
            showNotification('üìÑ Fitur export PDF sedang dalam pengembangan', 'info');
        }

        // Search and Archive functions
        function clearSearch() {
            document.getElementById('search-form').reset();
            document.getElementById('search-results-container').innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <div class="text-4xl mb-4">üîç</div>
                    <p>Gunakan form pencarian di atas untuk mencari dokumen</p>
                    <p class="text-sm mt-2">Atau klik "Tampilkan Semua Dokumen" untuk melihat seluruh arsip</p>
                </div>
            `;
            document.getElementById('search-results-title').textContent = 'Hasil Pencarian (0 dokumen ditemukan)';
        }

        function showAllDocuments() {
            const allDocuments = [
                ...suratMasukData.map(surat => ({...surat, type: 'masuk'})),
                ...suratKeluarData.map(surat => ({...surat, type: 'keluar'}))
            ];
            
            displaySearchResults(allDocuments, 'Semua Dokumen');
        }

        function displaySearchResults(results, title) {
            const container = document.getElementById('search-results-container');
            const titleElement = document.getElementById('search-results-title');
            
            titleElement.textContent = `${title} (${results.length} dokumen ditemukan)`;
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-4">üì≠</div>
                        <p>Tidak ada dokumen yang sesuai dengan kriteria pencarian</p>
                        <p class="text-sm mt-2">Coba ubah kata kunci atau filter pencarian</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="space-y-4">';
            
            results.forEach(doc => {
                const typeIcon = doc.type === 'masuk' ? 'üì•' : 'üì§';
                const typeText = doc.type === 'masuk' ? 'Surat Masuk' : 'Surat Keluar';
                const typeColor = doc.type === 'masuk' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800';
                
                html += `
                    <div class="border rounded-lg p-4 hover:bg-gray-50">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="text-xl">${typeIcon}</span>
                                    <span class="px-2 py-1 text-xs rounded-full ${typeColor}">${typeText}</span>
                                    <span class="px-2 py-1 text-xs rounded-full ${getKlasifikasiColor(doc.Klasifikasi)}">${doc.Klasifikasi}</span>
                                </div>
                                <h4 class="font-medium text-gray-900 mb-1">No. ${doc['No. Surat']}</h4>
                                <p class="text-sm text-gray-600 mb-2">${doc.Perihal}</p>
                                <div class="text-xs text-gray-500 space-x-4">
                                    <span>üìÖ ${formatDate(doc['Tanggal Surat'])}</span>
                                    <span>${doc.type === 'masuk' ? 'üë§ Dari: ' + doc.Pengirim : 'üë• Ke: ' + doc.Penerima}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Report functions
        function updateReportStats() {
            const totalMasuk = suratMasukData.length;
            const totalKeluar = suratKeluarData.length;
            const pending = suratMasukData.filter(s => s.Status === 'Menunggu Disposisi').length;
            const processed = suratMasukData.filter(s => s.Status === 'Diproses' || s.Status === 'Selesai').length;
            
            document.getElementById('report-total-masuk').textContent = totalMasuk;
            document.getElementById('report-total-keluar').textContent = totalKeluar;
            document.getElementById('report-pending').textContent = pending;
            document.getElementById('report-processed').textContent = processed;
        }

        function initializeReportCharts() {
            // Trend Chart
            const trendCtx = document.getElementById('trendChart');
            if (trendCtx && trendChart) {
                trendChart.destroy();
            }
            
            if (trendCtx) {
                const months = [];
                const masukData = [];
                const keluarData = [];
                
                for (let i = 5; i >= 0; i--) {
                    const date = new Date();
                    date.setMonth(date.getMonth() - i);
                    months.push(date.toLocaleDateString('id-ID', { month: 'short' }));
                    
                    const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
                    const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);
                    
                    const masuk = suratMasukData.filter(s => {
                        const d = new Date(s['Tanggal Diterima']);
                        return d >= monthStart && d <= monthEnd;
                    }).length;
                    
                    const keluar = suratKeluarData.filter(s => {
                        const d = new Date(s['Tanggal Surat']);
                        return d >= monthStart && d <= monthEnd;
                    }).length;
                    
                    masukData.push(masuk);
                    keluarData.push(keluar);
                }
                
                trendChart = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Surat Masuk',
                            data: masukData,
                            borderColor: 'rgb(59, 130, 246)',
                            tension: 0.4
                        }, {
                            label: 'Surat Keluar',
                            data: keluarData,
                            borderColor: 'rgb(34, 197, 94)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // Classification Chart
            const classCtx = document.getElementById('classificationChart');
            if (classCtx && classificationChart) {
                classificationChart.destroy();
            }
            
            if (classCtx) {
                const classifications = {};
                [...suratMasukData, ...suratKeluarData].forEach(surat => {
                    const klasifikasi = surat.Klasifikasi || 'Lainnya';
                    classifications[klasifikasi] = (classifications[klasifikasi] || 0) + 1;
                });
                
                classificationChart = new Chart(classCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(classifications),
                        datasets: [{
                            data: Object.values(classifications),
                            backgroundColor: [
                                '#ef4444', '#f97316', '#3b82f6', '#10b981',
                                '#8b5cf6', '#ec4899', '#6b7280'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
        }

        function generateDailyReport() {
            const today = new Date().toDateString();
            
            const suratMasukHariIni = suratMasukData.filter(surat => {
                const suratDate = new Date(surat['Tanggal Diterima']).toDateString();
                return suratDate === today;
            });
            
            const suratKeluarHariIni = suratKeluarData.filter(surat => {
                const suratDate = new Date(surat['Tanggal Surat']).toDateString();
                return suratDate === today;
            });
            
            const reportContent = `
                <div class="space-y-6">
                    <div class="text-center">
                        <h3 class="text-xl font-bold mb-2">Laporan Harian</h3>
                        <p class="text-gray-600">${new Date().toLocaleDateString('id-ID', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-800 mb-3">üì• Surat Masuk (${suratMasukHariIni.length})</h4>
                            ${suratMasukHariIni.length > 0 ? 
                                suratMasukHariIni.map(surat => `
                                    <div class="text-sm mb-2">
                                        <div class="font-medium">${surat['No. Surat']}</div>
                                        <div class="text-gray-600">${surat.Pengirim} - ${surat.Perihal}</div>
                                    </div>
                                `).join('') : 
                                '<p class="text-sm text-gray-600">Tidak ada surat masuk hari ini</p>'
                            }
                        </div>
                        
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-green-800 mb-3">üì§ Surat Keluar (${suratKeluarHariIni.length})</h4>
                            ${suratKeluarHariIni.length > 0 ? 
                                suratKeluarHariIni.map(surat => `
                                    <div class="text-sm mb-2">
                                        <div class="font-medium">${surat['No. Surat']}</div>
                                        <div class="text-gray-600">${surat.Penerima} - ${surat.Perihal}</div>
                                    </div>
                                `).join('') : 
                                '<p class="text-sm text-gray-600">Tidak ada surat keluar hari ini</p>'
                            }
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('report-content').innerHTML = reportContent;
            document.getElementById('report-results').classList.remove('hidden');
        }

        function hideReportResults() {
            document.getElementById('report-results').classList.add('hidden');
        }

        function printReport() {
            window.print();
        }

        function exportReport() {
            showNotification('üìä Fitur export Excel sedang dalam pengembangan', 'info');
        }

        // Setup search form
        document.addEventListener('DOMContentLoaded', function() {
            const searchForm = document.getElementById('search-form');
            if (searchForm) {
                searchForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const nomor = document.getElementById('search-nomor').value.toLowerCase();
                    const perihal = document.getElementById('search-perihal').value.toLowerCase();
                    const jenis = document.getElementById('search-jenis').value;
                    const tanggalMulai = document.getElementById('search-tanggal-mulai').value;
                    const tanggalAkhir = document.getElementById('search-tanggal-akhir').value;
                    
                    let results = [];
                    
                    if (jenis === '' || jenis === 'masuk') {
                        const filteredMasuk = suratMasukData.filter(surat => {
                            let match = true;
                            
                            if (nomor && !surat['No. Surat'].toLowerCase().includes(nomor)) match = false;
                            if (perihal && !surat.Perihal.toLowerCase().includes(perihal)) match = false;
                            
                            if (tanggalMulai) {
                                const suratDate = new Date(surat['Tanggal Diterima']);
                                const startDate = new Date(tanggalMulai);
                                if (suratDate < startDate) match = false;
                            }
                            
                            if (tanggalAkhir) {
                                const suratDate = new Date(surat['Tanggal Diterima']);
                                const endDate = new Date(tanggalAkhir);
                                if (suratDate > endDate) match = false;
                            }
                            
                            return match;
                        }).map(surat => ({...surat, type: 'masuk'}));
                        
                        results = results.concat(filteredMasuk);
                    }
                    
                    if (jenis === '' || jenis === 'keluar') {
                        const filteredKeluar = suratKeluarData.filter(surat => {
                            let match = true;
                            
                            if (nomor && !surat['No. Surat'].toLowerCase().includes(nomor)) match = false;
                            if (perihal && !surat.Perihal.toLowerCase().includes(perihal)) match = false;
                            
                            if (tanggalMulai) {
                                const suratDate = new Date(surat['Tanggal Surat']);
                                const startDate = new Date(tanggalMulai);
                                if (suratDate < startDate) match = false;
                            }
                            
                            if (tanggalAkhir) {
                                const suratDate = new Date(surat['Tanggal Surat']);
                                const endDate = new Date(tanggalAkhir);
                                if (suratDate > endDate) match = false;
                            }
                            
                            return match;
                        }).map(surat => ({...surat, type: 'keluar'}));
                        
                        results = results.concat(filteredKeluar);
                    }
                    
                    displaySearchResults(results, 'Hasil Pencarian');
                });
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9921a080f6e8b5d0',t:'MTc2MTA1ODg1Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
